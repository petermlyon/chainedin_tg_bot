<!DOCTYPE html>
<html>
<head>
  <title>scrypt.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/@noble/hashes/scrypt.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#sourcemappingurlscrypt.js.map">sourceMappingURL=scrypt.js.map</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>scrypt.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-built_in">Object</span>.defineProperty(exports, <span class="hljs-string">"__esModule"</span>, { <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> });
exports.scryptAsync = exports.scrypt = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> _assert_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./_assert.js"</span>);
<span class="hljs-keyword">const</span> sha256_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./sha256.js"</span>);
<span class="hljs-keyword">const</span> pbkdf2_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./pbkdf2.js"</span>);
<span class="hljs-keyword">const</span> utils_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./utils.js"</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>RFC 7914 Scrypt KDF
The main Scrypt loop: uses Salsa extensively.
Six versions of the function were tried, this is the fastest one.
prettier-ignore</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">XorAndSalsa</span>(<span class="hljs-params">prev, pi, input, ii, out, oi</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Based on https://cr.yp.to/salsa20.html
Xor blocks</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">let</span> y00 = prev[pi++] ^ input[ii++], y01 = prev[pi++] ^ input[ii++];
    <span class="hljs-keyword">let</span> y02 = prev[pi++] ^ input[ii++], y03 = prev[pi++] ^ input[ii++];
    <span class="hljs-keyword">let</span> y04 = prev[pi++] ^ input[ii++], y05 = prev[pi++] ^ input[ii++];
    <span class="hljs-keyword">let</span> y06 = prev[pi++] ^ input[ii++], y07 = prev[pi++] ^ input[ii++];
    <span class="hljs-keyword">let</span> y08 = prev[pi++] ^ input[ii++], y09 = prev[pi++] ^ input[ii++];
    <span class="hljs-keyword">let</span> y10 = prev[pi++] ^ input[ii++], y11 = prev[pi++] ^ input[ii++];
    <span class="hljs-keyword">let</span> y12 = prev[pi++] ^ input[ii++], y13 = prev[pi++] ^ input[ii++];
    <span class="hljs-keyword">let</span> y14 = prev[pi++] ^ input[ii++], y15 = prev[pi++] ^ input[ii++];
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Save state to temporary variables (salsa)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">let</span> x00 = y00, x01 = y01, x02 = y02, x03 = y03, x04 = y04, x05 = y05, x06 = y06, x07 = y07, x08 = y08, x09 = y09, x10 = y10, x11 = y11, x12 = y12, x13 = y13, x14 = y14, x15 = y15;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Main loop (salsa)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i += <span class="hljs-number">2</span>) {
        x04 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x00 + x12 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x08 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x04 + x00 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x12 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x08 + x04 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x00 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x12 + x08 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
        x09 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x05 + x01 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x13 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x09 + x05 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x01 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x13 + x09 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x05 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x01 + x13 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
        x14 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x10 + x06 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x02 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x14 + x10 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x06 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x02 + x14 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x10 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x06 + x02 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
        x03 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x15 + x11 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x07 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x03 + x15 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x11 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x07 + x03 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x15 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x11 + x07 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
        x01 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x00 + x03 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x02 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x01 + x00 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x03 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x02 + x01 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x00 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x03 + x02 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
        x06 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x05 + x04 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x07 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x06 + x05 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x04 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x07 + x06 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x05 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x04 + x07 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
        x11 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x10 + x09 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x08 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x11 + x10 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x09 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x08 + x11 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x10 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x09 + x08 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
        x12 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x15 + x14 | <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);
        x13 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x12 + x15 | <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        x14 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x13 + x12 | <span class="hljs-number">0</span>, <span class="hljs-number">13</span>);
        x15 ^= (<span class="hljs-number">0</span>, utils_js_1.rotl)(x14 + x13 | <span class="hljs-number">0</span>, <span class="hljs-number">18</span>);
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Write output (salsa)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    out[oi++] = (y00 + x00) | <span class="hljs-number">0</span>;
    out[oi++] = (y01 + x01) | <span class="hljs-number">0</span>;
    out[oi++] = (y02 + x02) | <span class="hljs-number">0</span>;
    out[oi++] = (y03 + x03) | <span class="hljs-number">0</span>;
    out[oi++] = (y04 + x04) | <span class="hljs-number">0</span>;
    out[oi++] = (y05 + x05) | <span class="hljs-number">0</span>;
    out[oi++] = (y06 + x06) | <span class="hljs-number">0</span>;
    out[oi++] = (y07 + x07) | <span class="hljs-number">0</span>;
    out[oi++] = (y08 + x08) | <span class="hljs-number">0</span>;
    out[oi++] = (y09 + x09) | <span class="hljs-number">0</span>;
    out[oi++] = (y10 + x10) | <span class="hljs-number">0</span>;
    out[oi++] = (y11 + x11) | <span class="hljs-number">0</span>;
    out[oi++] = (y12 + x12) | <span class="hljs-number">0</span>;
    out[oi++] = (y13 + x13) | <span class="hljs-number">0</span>;
    out[oi++] = (y14 + x14) | <span class="hljs-number">0</span>;
    out[oi++] = (y15 + x15) | <span class="hljs-number">0</span>;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BlockMix</span>(<span class="hljs-params">input, ii, out, oi, r</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>The block B is r 128-byte chunks (which is equivalent of 2r 64-byte chunks)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">let</span> head = oi + <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> tail = oi + <span class="hljs-number">16</span> * r;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)
        out[tail + i] = input[ii + (<span class="hljs-number">2</span> * r - <span class="hljs-number">1</span>) * <span class="hljs-number">16</span> + i]; <span class="hljs-comment">// X ← B[2r−1]</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; r; i++, head += <span class="hljs-number">16</span>, ii += <span class="hljs-number">16</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>We write odd &amp; even Yi at same time. Even: 0bXXXXX0 Odd:  0bXXXXX1</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        XorAndSalsa(out, tail, input, ii, out, head); <span class="hljs-comment">// head[i] = Salsa(blockIn[2*i] ^ tail[i-1])</span>
        <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>)
            tail += <span class="hljs-number">16</span>; <span class="hljs-comment">// First iteration overwrites tmp value in tail</span>
        XorAndSalsa(out, head, input, (ii += <span class="hljs-number">16</span>), out, tail); <span class="hljs-comment">// tail[i] = Salsa(blockIn[2*i+1] ^ head[i])</span>
    }
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Common prologue and epilogue for sync/async functions</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scryptInit</span>(<span class="hljs-params">password, salt, _opts</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Maxmem - 1GB+1KB by default</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> opts = (<span class="hljs-number">0</span>, utils_js_1.checkOpts)({
        <span class="hljs-attr">dkLen</span>: <span class="hljs-number">32</span>,
        <span class="hljs-attr">asyncTick</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">maxmem</span>: <span class="hljs-number">1024</span> ** <span class="hljs-number">3</span> + <span class="hljs-number">1024</span>,
    }, _opts);
    <span class="hljs-keyword">const</span> { N, r, p, dkLen, asyncTick, maxmem, onProgress } = opts;
    (<span class="hljs-number">0</span>, _assert_js_1.number)(N);
    (<span class="hljs-number">0</span>, _assert_js_1.number)(r);
    (<span class="hljs-number">0</span>, _assert_js_1.number)(p);
    (<span class="hljs-number">0</span>, _assert_js_1.number)(dkLen);
    (<span class="hljs-number">0</span>, _assert_js_1.number)(asyncTick);
    (<span class="hljs-number">0</span>, _assert_js_1.number)(maxmem);
    <span class="hljs-keyword">if</span> (onProgress !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> onProgress !== <span class="hljs-string">'function'</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'progressCb should be function'</span>);
    <span class="hljs-keyword">const</span> blockSize = <span class="hljs-number">128</span> * r;
    <span class="hljs-keyword">const</span> blockSize32 = blockSize / <span class="hljs-number">4</span>;
    <span class="hljs-keyword">if</span> (N &lt;= <span class="hljs-number">1</span> || (N &amp; (N - <span class="hljs-number">1</span>)) !== <span class="hljs-number">0</span> || N &gt;= <span class="hljs-number">2</span> ** (blockSize / <span class="hljs-number">8</span>) || N &gt; <span class="hljs-number">2</span> ** <span class="hljs-number">32</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>NOTE: we limit N to be less than 2**32 because of 32 bit variant of Integrify function
There is no JS engines that allows alocate more than 4GB per single Uint8Array for now, but can change in future.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Scrypt: N must be larger than 1, a power of 2, less than 2^(128 * r / 8) and less than 2^32'</span>);
    }
    <span class="hljs-keyword">if</span> (p &lt; <span class="hljs-number">0</span> || p &gt; ((<span class="hljs-number">2</span> ** <span class="hljs-number">32</span> - <span class="hljs-number">1</span>) * <span class="hljs-number">32</span>) / blockSize) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)'</span>);
    }
    <span class="hljs-keyword">if</span> (dkLen &lt; <span class="hljs-number">0</span> || dkLen &gt; (<span class="hljs-number">2</span> ** <span class="hljs-number">32</span> - <span class="hljs-number">1</span>) * <span class="hljs-number">32</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32'</span>);
    }
    <span class="hljs-keyword">const</span> memUsed = blockSize * (N + p);
    <span class="hljs-keyword">if</span> (memUsed &gt; maxmem) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Scrypt: parameters too large, <span class="hljs-subst">${memUsed}</span> (128 * r * (N + p)) &gt; <span class="hljs-subst">${maxmem}</span> (maxmem)`</span>);
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>[B0...Bp−1] ← PBKDF2HMAC-SHA256(Passphrase, Salt, 1, blockSize*ParallelizationFactor)
Since it has only one iteration there is no reason to use async variant</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> B = (<span class="hljs-number">0</span>, pbkdf2_js_1.pbkdf2)(sha256_js_1.sha256, password, salt, { <span class="hljs-attr">c</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">dkLen</span>: blockSize * p });
    <span class="hljs-keyword">const</span> B32 = (<span class="hljs-number">0</span>, utils_js_1.u32)(B);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Re-used between parallel iterations. Array(iterations) of B</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> V = (<span class="hljs-number">0</span>, utils_js_1.u32)(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(blockSize * N));
    <span class="hljs-keyword">const</span> tmp = (<span class="hljs-number">0</span>, utils_js_1.u32)(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(blockSize));
    <span class="hljs-keyword">let</span> blockMixCb = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { };
    <span class="hljs-keyword">if</span> (onProgress) {
        <span class="hljs-keyword">const</span> totalBlockMix = <span class="hljs-number">2</span> * N * p;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Invoke callback if progress changes from 10.01 to 10.02
Allows to draw smooth progress bar on up to 8K screen</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> callbackPer = <span class="hljs-built_in">Math</span>.max(<span class="hljs-built_in">Math</span>.floor(totalBlockMix / <span class="hljs-number">10000</span>), <span class="hljs-number">1</span>);
        <span class="hljs-keyword">let</span> blockMixCnt = <span class="hljs-number">0</span>;
        blockMixCb = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            blockMixCnt++;
            <span class="hljs-keyword">if</span> (onProgress &amp;&amp; (!(blockMixCnt % callbackPer) || blockMixCnt === totalBlockMix))
                onProgress(blockMixCnt / totalBlockMix);
        };
    }
    <span class="hljs-keyword">return</span> { N, r, p, dkLen, blockSize32, V, B32, B, tmp, blockMixCb, asyncTick };
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scryptOutput</span>(<span class="hljs-params">password, dkLen, B, V, tmp</span>) </span>{
    <span class="hljs-keyword">const</span> res = (<span class="hljs-number">0</span>, pbkdf2_js_1.pbkdf2)(sha256_js_1.sha256, password, B, { <span class="hljs-attr">c</span>: <span class="hljs-number">1</span>, dkLen });
    B.fill(<span class="hljs-number">0</span>);
    V.fill(<span class="hljs-number">0</span>);
    tmp.fill(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> res;
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<div class="dox">
<div class="summary">
<p>Scrypt KDF from RFC 7914.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">password</span>
<span><ul>
<li>pass</li>
</ul>
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">salt</span>
<span><ul>
<li>salt</li>
</ul>
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">opts</span>
<span><ul>
<li>parameters - <code>N</code> is cpu/mem work factor (power of 2 e.g. 2**18)</li>
<li><code>r</code> is block size (8 is common), fine-tunes sequential memory read size and performance</li>
<li><code>p</code> is parallelization factor (1 is common)</li>
<li><code>dkLen</code> is output key length in bytes e.g. 32.</li>
<li><code>asyncTick</code> - (default: 10) max time in ms for which async function can block execution</li>
<li><code>maxmem</code> - (default: <code>1024 ** 3 + 1024</code> aka 1GB+1KB). A limit that the app could use for scrypt</li>
<li><code>onProgress</code> - callback function that would be executed for progress report</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scrypt</span>(<span class="hljs-params">password, salt, opts</span>) </span>{
    <span class="hljs-keyword">const</span> { N, r, p, dkLen, blockSize32, V, B32, B, tmp, blockMixCb } = scryptInit(password, salt, opts);
    <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
        (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(B32);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pi = <span class="hljs-number">0</span>; pi &lt; p; pi++) {
        <span class="hljs-keyword">const</span> Pi = blockSize32 * pi;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; blockSize32; i++)
            V[i] = B32[Pi + i]; <span class="hljs-comment">// V[0] = B[i]</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, pos = <span class="hljs-number">0</span>; i &lt; N - <span class="hljs-number">1</span>; i++) {
            BlockMix(V, pos, V, (pos += blockSize32), r); <span class="hljs-comment">// V[i] = BlockMix(V[i-1]);</span>
            blockMixCb();
        }
        BlockMix(V, (N - <span class="hljs-number">1</span>) * blockSize32, B32, Pi, r); <span class="hljs-comment">// Process last element</span>
        blockMixCb();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>First u32 of the last 64-byte block (u32 is LE)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">const</span> j = B32[Pi + blockSize32 - <span class="hljs-number">16</span>] % N; <span class="hljs-comment">// j = Integrify(X) % iterations</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; blockSize32; k++)
                tmp[k] = B32[Pi + k] ^ V[j * blockSize32 + k]; <span class="hljs-comment">// tmp = B ^ V[j]</span>
            BlockMix(tmp, <span class="hljs-number">0</span>, B32, Pi, r); <span class="hljs-comment">// B = BlockMix(B ^ V[j])</span>
            blockMixCb();
        }
    }
    <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
        (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(B32);
    <span class="hljs-keyword">return</span> scryptOutput(password, dkLen, B, V, tmp);
}
exports.scrypt = scrypt;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<div class="dox">
<div class="summary">
<p>Scrypt KDF from RFC 7914.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scryptAsync</span>(<span class="hljs-params">password, salt, opts</span>) </span>{
    <span class="hljs-keyword">const</span> { N, r, p, dkLen, blockSize32, V, B32, B, tmp, blockMixCb, asyncTick } = scryptInit(password, salt, opts);
    <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
        (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(B32);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pi = <span class="hljs-number">0</span>; pi &lt; p; pi++) {
        <span class="hljs-keyword">const</span> Pi = blockSize32 * pi;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; blockSize32; i++)
            V[i] = B32[Pi + i]; <span class="hljs-comment">// V[0] = B[i]</span>
        <span class="hljs-keyword">let</span> pos = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">await</span> (<span class="hljs-number">0</span>, utils_js_1.asyncLoop)(N - <span class="hljs-number">1</span>, asyncTick, () =&gt; {
            BlockMix(V, pos, V, (pos += blockSize32), r); <span class="hljs-comment">// V[i] = BlockMix(V[i-1]);</span>
            blockMixCb();
        });
        BlockMix(V, (N - <span class="hljs-number">1</span>) * blockSize32, B32, Pi, r); <span class="hljs-comment">// Process last element</span>
        blockMixCb();
        <span class="hljs-keyword">await</span> (<span class="hljs-number">0</span>, utils_js_1.asyncLoop)(N, asyncTick, () =&gt; {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>First u32 of the last 64-byte block (u32 is LE)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">const</span> j = B32[Pi + blockSize32 - <span class="hljs-number">16</span>] % N; <span class="hljs-comment">// j = Integrify(X) % iterations</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; blockSize32; k++)
                tmp[k] = B32[Pi + k] ^ V[j * blockSize32 + k]; <span class="hljs-comment">// tmp = B ^ V[j]</span>
            BlockMix(tmp, <span class="hljs-number">0</span>, B32, Pi, r); <span class="hljs-comment">// B = BlockMix(B ^ V[j])</span>
            blockMixCb();
        });
    }
    <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
        (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(B32);
    <span class="hljs-keyword">return</span> scryptOutput(password, dkLen, B, V, tmp);
}
exports.scryptAsync = scryptAsync;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="sourcemappingurlscrypt.js.map">
  <h1>
    <a href="#sourcemappingurlscrypt.js.map" name="sourcemappingurlscrypt.js.map" class="pilcrow"></a>
sourceMappingURL=scrypt.js.map
  </h1>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"></pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
