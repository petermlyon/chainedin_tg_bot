<!DOCTYPE html>
<html>
<head>
  <title>_blake.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/@noble/hashes/_blake.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#sourcemappingurl_blake.js.map">sourceMappingURL=_blake.js.map</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>_blake.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-built_in">Object</span>.defineProperty(exports, <span class="hljs-string">"__esModule"</span>, { <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> });
exports.BLAKE = exports.SIGMA = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> _assert_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./_assert.js"</span>);
<span class="hljs-keyword">const</span> utils_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./utils.js"</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Blake is based on ChaCha permutation.
For BLAKE2b, the two extra permutations for rounds 10 and 11 are SIGMA[10..11] = SIGMA[0..1].
prettier-ignore</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">exports.SIGMA = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>([
    <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>,
    <span class="hljs-number">14</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">15</span>, <span class="hljs-number">13</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">12</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">11</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>,
    <span class="hljs-number">11</span>, <span class="hljs-number">8</span>, <span class="hljs-number">12</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">15</span>, <span class="hljs-number">13</span>, <span class="hljs-number">10</span>, <span class="hljs-number">14</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">4</span>,
    <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">13</span>, <span class="hljs-number">12</span>, <span class="hljs-number">11</span>, <span class="hljs-number">14</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">8</span>,
    <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>, <span class="hljs-number">1</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-number">13</span>,
    <span class="hljs-number">2</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">11</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">13</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>,
    <span class="hljs-number">12</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>, <span class="hljs-number">13</span>, <span class="hljs-number">4</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>,
    <span class="hljs-number">13</span>, <span class="hljs-number">11</span>, <span class="hljs-number">7</span>, <span class="hljs-number">14</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">10</span>,
    <span class="hljs-number">6</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">12</span>, <span class="hljs-number">2</span>, <span class="hljs-number">13</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>,
    <span class="hljs-number">10</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">15</span>, <span class="hljs-number">11</span>, <span class="hljs-number">9</span>, <span class="hljs-number">14</span>, <span class="hljs-number">3</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">0</span>,
    <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>,
    <span class="hljs-number">14</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">15</span>, <span class="hljs-number">13</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">12</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">11</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>,
]);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BLAKE</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">utils_js_1</span>.<span class="hljs-title">Hash</span> </span>{
    <span class="hljs-keyword">constructor</span>(blockLen, outputLen, opts = {}, keyLen, saltLen, persLen) {
        <span class="hljs-keyword">super</span>();
        <span class="hljs-keyword">this</span>.blockLen = blockLen;
        <span class="hljs-keyword">this</span>.outputLen = outputLen;
        <span class="hljs-keyword">this</span>.length = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.pos = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.finished = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">this</span>.destroyed = <span class="hljs-literal">false</span>;
        (<span class="hljs-number">0</span>, _assert_js_1.number)(blockLen);
        (<span class="hljs-number">0</span>, _assert_js_1.number)(outputLen);
        (<span class="hljs-number">0</span>, _assert_js_1.number)(keyLen);
        <span class="hljs-keyword">if</span> (outputLen &lt; <span class="hljs-number">0</span> || outputLen &gt; keyLen)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'outputLen bigger than keyLen'</span>);
        <span class="hljs-keyword">if</span> (opts.key !== <span class="hljs-literal">undefined</span> &amp;&amp; (opts.key.length &lt; <span class="hljs-number">1</span> || opts.key.length &gt; keyLen))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`key must be up 1..<span class="hljs-subst">${keyLen}</span> byte long or undefined`</span>);
        <span class="hljs-keyword">if</span> (opts.salt !== <span class="hljs-literal">undefined</span> &amp;&amp; opts.salt.length !== saltLen)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`salt must be <span class="hljs-subst">${saltLen}</span> byte long or undefined`</span>);
        <span class="hljs-keyword">if</span> (opts.personalization !== <span class="hljs-literal">undefined</span> &amp;&amp; opts.personalization.length !== persLen)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`personalization must be <span class="hljs-subst">${persLen}</span> byte long or undefined`</span>);
        <span class="hljs-keyword">this</span>.buffer32 = (<span class="hljs-number">0</span>, utils_js_1.u32)((<span class="hljs-keyword">this</span>.buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(blockLen)));
    }
    update(data) {
        (<span class="hljs-number">0</span>, _assert_js_1.exists)(<span class="hljs-keyword">this</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Main difference with other hashes: there is flag for last block,
so we cannot process current block before we know that there
is the next one. This significantly complicates logic and reduces ability
to do zero-copy processing</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> { blockLen, buffer, buffer32 } = <span class="hljs-keyword">this</span>;
        data = (<span class="hljs-number">0</span>, utils_js_1.toBytes)(data);
        <span class="hljs-keyword">const</span> len = data.length;
        <span class="hljs-keyword">const</span> offset = data.byteOffset;
        <span class="hljs-keyword">const</span> buf = data.buffer;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pos = <span class="hljs-number">0</span>; pos &lt; len;) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>If buffer is full and we still have input (don't process last block, same as blake2s)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pos === blockLen) {
                <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
                    (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(buffer32);
                <span class="hljs-keyword">this</span>.compress(buffer32, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
                    (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(buffer32);
                <span class="hljs-keyword">this</span>.pos = <span class="hljs-number">0</span>;
            }
            <span class="hljs-keyword">const</span> take = <span class="hljs-built_in">Math</span>.min(blockLen - <span class="hljs-keyword">this</span>.pos, len - pos);
            <span class="hljs-keyword">const</span> dataOffset = offset + pos;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>full block &amp;&amp; aligned to 4 bytes &amp;&amp; not last in input</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (take === blockLen &amp;&amp; !(dataOffset % <span class="hljs-number">4</span>) &amp;&amp; pos + take &lt; len) {
                <span class="hljs-keyword">const</span> data32 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(buf, dataOffset, <span class="hljs-built_in">Math</span>.floor((len - pos) / <span class="hljs-number">4</span>));
                <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
                    (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(data32);
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pos32 = <span class="hljs-number">0</span>; pos + blockLen &lt; len; pos32 += buffer32.length, pos += blockLen) {
                    <span class="hljs-keyword">this</span>.length += blockLen;
                    <span class="hljs-keyword">this</span>.compress(data32, pos32, <span class="hljs-literal">false</span>);
                }
                <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
                    (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(data32);
                <span class="hljs-keyword">continue</span>;
            }
            buffer.set(data.subarray(pos, pos + take), <span class="hljs-keyword">this</span>.pos);
            <span class="hljs-keyword">this</span>.pos += take;
            <span class="hljs-keyword">this</span>.length += take;
            pos += take;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    digestInto(out) {
        (<span class="hljs-number">0</span>, _assert_js_1.exists)(<span class="hljs-keyword">this</span>);
        (<span class="hljs-number">0</span>, _assert_js_1.output)(out, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">const</span> { pos, buffer32 } = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.finished = <span class="hljs-literal">true</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Padding</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">this</span>.buffer.subarray(pos).fill(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
            (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(buffer32);
        <span class="hljs-keyword">this</span>.compress(buffer32, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">if</span> (!utils_js_1.isLE)
            (<span class="hljs-number">0</span>, utils_js_1.byteSwap32)(buffer32);
        <span class="hljs-keyword">const</span> out32 = (<span class="hljs-number">0</span>, utils_js_1.u32)(out);
        <span class="hljs-keyword">this</span>.get().forEach(<span class="hljs-function">(<span class="hljs-params">v, i</span>) =&gt;</span> (out32[i] = (<span class="hljs-number">0</span>, utils_js_1.byteSwapIfBE)(v)));
    }
    digest() {
        <span class="hljs-keyword">const</span> { buffer, outputLen } = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.digestInto(buffer);
        <span class="hljs-keyword">const</span> res = buffer.slice(<span class="hljs-number">0</span>, outputLen);
        <span class="hljs-keyword">this</span>.destroy();
        <span class="hljs-keyword">return</span> res;
    }
    _cloneInto(to) {
        <span class="hljs-keyword">const</span> { buffer, length, finished, destroyed, outputLen, pos } = <span class="hljs-keyword">this</span>;
        to || (to = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.constructor({ <span class="hljs-attr">dkLen</span>: outputLen }));
        to.set(...this.get());
        to.length = length;
        to.finished = finished;
        to.destroyed = destroyed;
        to.outputLen = outputLen;
        to.buffer.set(buffer);
        to.pos = pos;
        <span class="hljs-keyword">return</span> to;
    }
}
exports.BLAKE = BLAKE;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="sourcemappingurl_blake.js.map">
  <h1>
    <a href="#sourcemappingurl_blake.js.map" name="sourcemappingurl_blake.js.map" class="pilcrow"></a>
sourceMappingURL=_blake.js.map
  </h1>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"></pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
