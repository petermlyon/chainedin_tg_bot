<!DOCTYPE html>
<html>
<head>
  <title>_md.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/@noble/hashes/_md.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#sourcemappingurl_md.js.map">sourceMappingURL=_md.js.map</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>_md.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-built_in">Object</span>.defineProperty(exports, <span class="hljs-string">"__esModule"</span>, { <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> });
exports.HashMD = exports.Maj = exports.Chi = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> _assert_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./_assert.js"</span>);
<span class="hljs-keyword">const</span> utils_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./utils.js"</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Polyfill for Safari 14</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setBigUint64</span>(<span class="hljs-params">view, byteOffset, value, isLE</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> view.setBigUint64 === <span class="hljs-string">'function'</span>)
        <span class="hljs-keyword">return</span> view.setBigUint64(byteOffset, value, isLE);
    <span class="hljs-keyword">const</span> _32n = BigInt(<span class="hljs-number">32</span>);
    <span class="hljs-keyword">const</span> _u32_max = BigInt(<span class="hljs-number">0xffffffff</span>);
    <span class="hljs-keyword">const</span> wh = <span class="hljs-built_in">Number</span>((value &gt;&gt; _32n) &amp; _u32_max);
    <span class="hljs-keyword">const</span> wl = <span class="hljs-built_in">Number</span>(value &amp; _u32_max);
    <span class="hljs-keyword">const</span> h = isLE ? <span class="hljs-number">4</span> : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> l = isLE ? <span class="hljs-number">0</span> : <span class="hljs-number">4</span>;
    view.setUint32(byteOffset + h, wh, isLE);
    view.setUint32(byteOffset + l, wl, isLE);
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Choice: a ? b : c</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> Chi = <span class="hljs-function">(<span class="hljs-params">a, b, c</span>) =&gt;</span> (a &amp; b) ^ (~a &amp; c);
exports.Chi = Chi;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Majority function, true if any two inpust is true</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> Maj = <span class="hljs-function">(<span class="hljs-params">a, b, c</span>) =&gt;</span> (a &amp; b) ^ (a &amp; c) ^ (b &amp; c);
exports.Maj = Maj;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Merkle-Damgard hash construction base class.
Could be used to create MD5, RIPEMD, SHA1, SHA2.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HashMD</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">utils_js_1</span>.<span class="hljs-title">Hash</span> </span>{
    <span class="hljs-keyword">constructor</span>(blockLen, outputLen, padOffset, isLE) {
        <span class="hljs-keyword">super</span>();
        <span class="hljs-keyword">this</span>.blockLen = blockLen;
        <span class="hljs-keyword">this</span>.outputLen = outputLen;
        <span class="hljs-keyword">this</span>.padOffset = padOffset;
        <span class="hljs-keyword">this</span>.isLE = isLE;
        <span class="hljs-keyword">this</span>.finished = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">this</span>.length = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.pos = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.destroyed = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">this</span>.buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(blockLen);
        <span class="hljs-keyword">this</span>.view = (<span class="hljs-number">0</span>, utils_js_1.createView)(<span class="hljs-keyword">this</span>.buffer);
    }
    update(data) {
        (<span class="hljs-number">0</span>, _assert_js_1.exists)(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">const</span> { view, buffer, blockLen } = <span class="hljs-keyword">this</span>;
        data = (<span class="hljs-number">0</span>, utils_js_1.toBytes)(data);
        <span class="hljs-keyword">const</span> len = data.length;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pos = <span class="hljs-number">0</span>; pos &lt; len;) {
            <span class="hljs-keyword">const</span> take = <span class="hljs-built_in">Math</span>.min(blockLen - <span class="hljs-keyword">this</span>.pos, len - pos);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Fast path: we have at least one block in input, cast it to view and process</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (take === blockLen) {
                <span class="hljs-keyword">const</span> dataView = (<span class="hljs-number">0</span>, utils_js_1.createView)(data);
                <span class="hljs-keyword">for</span> (; blockLen &lt;= len - pos; pos += blockLen)
                    <span class="hljs-keyword">this</span>.process(dataView, pos);
                <span class="hljs-keyword">continue</span>;
            }
            buffer.set(data.subarray(pos, pos + take), <span class="hljs-keyword">this</span>.pos);
            <span class="hljs-keyword">this</span>.pos += take;
            pos += take;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pos === blockLen) {
                <span class="hljs-keyword">this</span>.process(view, <span class="hljs-number">0</span>);
                <span class="hljs-keyword">this</span>.pos = <span class="hljs-number">0</span>;
            }
        }
        <span class="hljs-keyword">this</span>.length += data.length;
        <span class="hljs-keyword">this</span>.roundClean();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    digestInto(out) {
        (<span class="hljs-number">0</span>, _assert_js_1.exists)(<span class="hljs-keyword">this</span>);
        (<span class="hljs-number">0</span>, _assert_js_1.output)(out, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">this</span>.finished = <span class="hljs-literal">true</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Padding
We can avoid allocation of buffer for padding completely if it
was previously not allocated here. But it won't change performance.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> { buffer, view, blockLen, isLE } = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">let</span> { pos } = <span class="hljs-keyword">this</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>append the bit '1' to the message</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        buffer[pos++] = <span class="hljs-number">0b10000000</span>;
        <span class="hljs-keyword">this</span>.buffer.subarray(pos).fill(<span class="hljs-number">0</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>we have less than padOffset left in buffer, so we cannot put length in
current block, need process it and pad again</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.padOffset &gt; blockLen - pos) {
            <span class="hljs-keyword">this</span>.process(view, <span class="hljs-number">0</span>);
            pos = <span class="hljs-number">0</span>;
        }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Pad until full block byte with zeros</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = pos; i &lt; blockLen; i++)
            buffer[i] = <span class="hljs-number">0</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Note: sha512 requires length to be 128bit integer, but length in JS will overflow before that
You need to write around 2 exabytes (u64_max / 8 / (1024**6)) for this to happen.
So we just write lowest 64 bits of that value.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        setBigUint64(view, blockLen - <span class="hljs-number">8</span>, BigInt(<span class="hljs-keyword">this</span>.length * <span class="hljs-number">8</span>), isLE);
        <span class="hljs-keyword">this</span>.process(view, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> oview = (<span class="hljs-number">0</span>, utils_js_1.createView)(out);
        <span class="hljs-keyword">const</span> len = <span class="hljs-keyword">this</span>.outputLen;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>NOTE: we do division by 4 later, which should be fused in single op with modulo by JIT</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (len % <span class="hljs-number">4</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'_sha2: outputLen should be aligned to 32bit'</span>);
        <span class="hljs-keyword">const</span> outLen = len / <span class="hljs-number">4</span>;
        <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">this</span>.get();
        <span class="hljs-keyword">if</span> (outLen &gt; state.length)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'_sha2: outputLen bigger than state'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; outLen; i++)
            oview.setUint32(<span class="hljs-number">4</span> * i, state[i], isLE);
    }
    digest() {
        <span class="hljs-keyword">const</span> { buffer, outputLen } = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.digestInto(buffer);
        <span class="hljs-keyword">const</span> res = buffer.slice(<span class="hljs-number">0</span>, outputLen);
        <span class="hljs-keyword">this</span>.destroy();
        <span class="hljs-keyword">return</span> res;
    }
    _cloneInto(to) {
        to || (to = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.constructor());
        to.set(...this.get());
        <span class="hljs-keyword">const</span> { blockLen, buffer, length, finished, destroyed, pos } = <span class="hljs-keyword">this</span>;
        to.length = length;
        to.pos = pos;
        to.finished = finished;
        to.destroyed = destroyed;
        <span class="hljs-keyword">if</span> (length % blockLen)
            to.buffer.set(buffer);
        <span class="hljs-keyword">return</span> to;
    }
}
exports.HashMD = HashMD;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="sourcemappingurl_md.js.map">
  <h1>
    <a href="#sourcemappingurl_md.js.map" name="sourcemappingurl_md.js.map" class="pilcrow"></a>
sourceMappingURL=_md.js.map
  </h1>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"></pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
