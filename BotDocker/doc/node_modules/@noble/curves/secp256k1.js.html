<!DOCTYPE html>
<html>
<head>
  <title>secp256k1.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/@noble/curves/secp256k1.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#sourcemappingurlsecp256k1.js.map">sourceMappingURL=secp256k1.js.map</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>secp256k1.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-built_in">Object</span>.defineProperty(exports, <span class="hljs-string">"__esModule"</span>, { <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> });
exports.encodeToCurve = exports.hashToCurve = exports.schnorr = exports.secp256k1 = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
<span class="hljs-comment">/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */</span>
<span class="hljs-keyword">const</span> sha256_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"@noble/hashes/sha256"</span>);
<span class="hljs-keyword">const</span> utils_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"@noble/hashes/utils"</span>);
<span class="hljs-keyword">const</span> _shortw_utils_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./_shortw_utils.js"</span>);
<span class="hljs-keyword">const</span> hash_to_curve_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./abstract/hash-to-curve.js"</span>);
<span class="hljs-keyword">const</span> modular_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./abstract/modular.js"</span>);
<span class="hljs-keyword">const</span> utils_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./abstract/utils.js"</span>);
<span class="hljs-keyword">const</span> weierstrass_js_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./abstract/weierstrass.js"</span>);
<span class="hljs-keyword">const</span> secp256k1P = BigInt(<span class="hljs-string">'0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f'</span>);
<span class="hljs-keyword">const</span> secp256k1N = BigInt(<span class="hljs-string">'0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141'</span>);
<span class="hljs-keyword">const</span> _1n = BigInt(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> _2n = BigInt(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> divNearest = <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> (a + b / _2n) / b;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>√n = n^((p+1)/4) for fields p = 3 mod 4. We unwrap the loop and multiply bit-by-bit.
(P+1n/4n).toString(2) would produce bits [223x 1, 0, 22x 1, 4x 0, 11, 00]</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sqrtMod</span>(<span class="hljs-params">y</span>) </span>{
    <span class="hljs-keyword">const</span> P = secp256k1P;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>prettier-ignore</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> _3n = BigInt(<span class="hljs-number">3</span>), _6n = BigInt(<span class="hljs-number">6</span>), _11n = BigInt(<span class="hljs-number">11</span>), _22n = BigInt(<span class="hljs-number">22</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>prettier-ignore</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> _23n = BigInt(<span class="hljs-number">23</span>), _44n = BigInt(<span class="hljs-number">44</span>), _88n = BigInt(<span class="hljs-number">88</span>);
    <span class="hljs-keyword">const</span> b2 = (y * y * y) % P; <span class="hljs-comment">// x^3, 11</span>
    <span class="hljs-keyword">const</span> b3 = (b2 * b2 * y) % P; <span class="hljs-comment">// x^7</span>
    <span class="hljs-keyword">const</span> b6 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b3, _3n, P) * b3) % P;
    <span class="hljs-keyword">const</span> b9 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b6, _3n, P) * b3) % P;
    <span class="hljs-keyword">const</span> b11 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b9, _2n, P) * b2) % P;
    <span class="hljs-keyword">const</span> b22 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b11, _11n, P) * b11) % P;
    <span class="hljs-keyword">const</span> b44 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b22, _22n, P) * b22) % P;
    <span class="hljs-keyword">const</span> b88 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b44, _44n, P) * b44) % P;
    <span class="hljs-keyword">const</span> b176 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b88, _88n, P) * b88) % P;
    <span class="hljs-keyword">const</span> b220 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b176, _44n, P) * b44) % P;
    <span class="hljs-keyword">const</span> b223 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b220, _3n, P) * b3) % P;
    <span class="hljs-keyword">const</span> t1 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(b223, _23n, P) * b22) % P;
    <span class="hljs-keyword">const</span> t2 = ((<span class="hljs-number">0</span>, modular_js_1.pow2)(t1, _6n, P) * b2) % P;
    <span class="hljs-keyword">const</span> root = (<span class="hljs-number">0</span>, modular_js_1.pow2)(t2, _2n, P);
    <span class="hljs-keyword">if</span> (!Fp.eql(Fp.sqr(root), y))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Cannot find square root'</span>);
    <span class="hljs-keyword">return</span> root;
}
<span class="hljs-keyword">const</span> Fp = (<span class="hljs-number">0</span>, modular_js_1.Field)(secp256k1P, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, { <span class="hljs-attr">sqrt</span>: sqrtMod });
exports.secp256k1 = (<span class="hljs-number">0</span>, _shortw_utils_js_1.createCurve)({
    <span class="hljs-attr">a</span>: BigInt(<span class="hljs-number">0</span>), <span class="hljs-comment">// equation params: a, b</span>
    <span class="hljs-attr">b</span>: BigInt(<span class="hljs-number">7</span>), <span class="hljs-comment">// Seem to be rigid: bitcointalk.org/index.php?topic=289795.msg3183975#msg3183975</span>
    Fp, <span class="hljs-comment">// Field's prime: 2n**256n - 2n**32n - 2n**9n - 2n**8n - 2n**7n - 2n**6n - 2n**4n - 1n</span>
    <span class="hljs-attr">n</span>: secp256k1N, <span class="hljs-comment">// Curve order, total count of valid points in the field</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Base point (x, y) aka generator point</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    Gx: BigInt(<span class="hljs-string">'55066263022277343669578718895168534326250603453777594175500187360389116729240'</span>),
    <span class="hljs-attr">Gy</span>: BigInt(<span class="hljs-string">'32670510020758816978083085130507043184471273380659243275938904335757337482424'</span>),
    <span class="hljs-attr">h</span>: BigInt(<span class="hljs-number">1</span>), <span class="hljs-comment">// Cofactor</span>
    <span class="hljs-attr">lowS</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Allow only low-S signatures by default in sign() and verify()</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>secp256k1 belongs to Koblitz curves: it has efficiently computable endomorphism.
Endomorphism uses 2x less RAM, speeds up precomputation by 2x and ECDH / key recovery by 20%.
For precomputed wNAF it trades off 1/2 init time &amp; 1/3 ram for 20% perf hit.
Explanation: https://gist.github.com/paulmillr/eb670806793e84df628a7c434a873066</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    endo: {
        <span class="hljs-attr">beta</span>: BigInt(<span class="hljs-string">'0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee'</span>),
        <span class="hljs-attr">splitScalar</span>: <span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> n = secp256k1N;
            <span class="hljs-keyword">const</span> a1 = BigInt(<span class="hljs-string">'0x3086d221a7d46bcde86c90e49284eb15'</span>);
            <span class="hljs-keyword">const</span> b1 = -_1n * BigInt(<span class="hljs-string">'0xe4437ed6010e88286f547fa90abfe4c3'</span>);
            <span class="hljs-keyword">const</span> a2 = BigInt(<span class="hljs-string">'0x114ca50f7a8e2f3f657c1108d9d44cfd8'</span>);
            <span class="hljs-keyword">const</span> b2 = a1;
            <span class="hljs-keyword">const</span> POW_2_128 = BigInt(<span class="hljs-string">'0x100000000000000000000000000000000'</span>); <span class="hljs-comment">// (2n**128n).toString(16)</span>
            <span class="hljs-keyword">const</span> c1 = divNearest(b2 * k, n);
            <span class="hljs-keyword">const</span> c2 = divNearest(-b1 * k, n);
            <span class="hljs-keyword">let</span> k1 = (<span class="hljs-number">0</span>, modular_js_1.mod)(k - c1 * a1 - c2 * a2, n);
            <span class="hljs-keyword">let</span> k2 = (<span class="hljs-number">0</span>, modular_js_1.mod)(-c1 * b1 - c2 * b2, n);
            <span class="hljs-keyword">const</span> k1neg = k1 &gt; POW_2_128;
            <span class="hljs-keyword">const</span> k2neg = k2 &gt; POW_2_128;
            <span class="hljs-keyword">if</span> (k1neg)
                k1 = n - k1;
            <span class="hljs-keyword">if</span> (k2neg)
                k2 = n - k2;
            <span class="hljs-keyword">if</span> (k1 &gt; POW_2_128 || k2 &gt; POW_2_128) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'splitScalar: Endomorphism failed, k='</span> + k);
            }
            <span class="hljs-keyword">return</span> { k1neg, k1, k2neg, k2 };
        },
    },
}, sha256_1.sha256);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Schnorr signatures are superior to ECDSA from above. Below is Schnorr-specific BIP0340 code.
https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> _0n = BigInt(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> fe = <span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'bigint'</span> &amp;&amp; _0n &lt; x &amp;&amp; x &lt; secp256k1P;
<span class="hljs-keyword">const</span> ge = <span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'bigint'</span> &amp;&amp; _0n &lt; x &amp;&amp; x &lt; secp256k1N;
<span class="hljs-comment">/** An object mapping tags to their tagged hash prefix of [SHA256(tag) | SHA256(tag)] */</span>
<span class="hljs-keyword">const</span> TAGGED_HASH_PREFIXES = {};
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">taggedHash</span>(<span class="hljs-params">tag, ...messages</span>) </span>{
    <span class="hljs-keyword">let</span> tagP = TAGGED_HASH_PREFIXES[tag];
    <span class="hljs-keyword">if</span> (tagP === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">const</span> tagH = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-number">0</span>, sha256_1.sha256</span>)(<span class="hljs-params"><span class="hljs-built_in">Uint8Array</span>.<span class="hljs-keyword">from</span>(tag, (c</span>) =&gt;</span> c.charCodeAt(<span class="hljs-number">0</span>)));
        tagP = (<span class="hljs-number">0</span>, utils_js_1.concatBytes)(tagH, tagH);
        TAGGED_HASH_PREFIXES[tag] = tagP;
    }
    <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span>, sha256_1.sha256)((<span class="hljs-number">0</span>, utils_js_1.concatBytes)(tagP, ...messages));
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>ECDSA compact points are 33-byte. Schnorr is 32: we strip first byte 0x02 or 0x03</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> pointToBytes = <span class="hljs-function">(<span class="hljs-params">point</span>) =&gt;</span> point.toRawBytes(<span class="hljs-literal">true</span>).slice(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> numTo32b = <span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> (<span class="hljs-number">0</span>, utils_js_1.numberToBytesBE)(n, <span class="hljs-number">32</span>);
<span class="hljs-keyword">const</span> modP = <span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> (<span class="hljs-number">0</span>, modular_js_1.mod)(x, secp256k1P);
<span class="hljs-keyword">const</span> modN = <span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> (<span class="hljs-number">0</span>, modular_js_1.mod)(x, secp256k1N);
<span class="hljs-keyword">const</span> Point = exports.secp256k1.ProjectivePoint;
<span class="hljs-keyword">const</span> GmulAdd = <span class="hljs-function">(<span class="hljs-params">Q, a, b</span>) =&gt;</span> Point.BASE.multiplyAndAddUnsafe(Q, a, b);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Calculate point, scalar and bytes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schnorrGetExtPubKey</span>(<span class="hljs-params">priv</span>) </span>{
    <span class="hljs-keyword">let</span> d_ = exports.secp256k1.utils.normPrivateKeyToScalar(priv); <span class="hljs-comment">// same method executed in fromPrivateKey</span>
    <span class="hljs-keyword">let</span> p = Point.fromPrivateKey(d_); <span class="hljs-comment">// P = d'⋅G; 0 &lt; d' &lt; n check is done inside</span>
    <span class="hljs-keyword">const</span> scalar = p.hasEvenY() ? d_ : modN(-d_);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">scalar</span>: scalar, <span class="hljs-attr">bytes</span>: pointToBytes(p) };
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>lift_x from BIP340. Convert 32-byte x coordinate to elliptic curve point.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lift_x</span>(<span class="hljs-params">x</span>) </span>{
    <span class="hljs-keyword">if</span> (!fe(x))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'bad x: need 0 &lt; x &lt; p'</span>); <span class="hljs-comment">// Fail if x ≥ p.</span>
    <span class="hljs-keyword">const</span> xx = modP(x * x);
    <span class="hljs-keyword">const</span> c = modP(xx * x + BigInt(<span class="hljs-number">7</span>)); <span class="hljs-comment">// Let c = x³ + 7 mod p.</span>
    <span class="hljs-keyword">let</span> y = sqrtMod(c); <span class="hljs-comment">// Let y = c^(p+1)/4 mod p.</span>
    <span class="hljs-keyword">if</span> (y % _2n !== _0n)
        y = modP(-y); <span class="hljs-comment">// Return the unique point P such that x(P) = x and</span>
    <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> Point(x, y, _1n); <span class="hljs-comment">// y(P) = y if y mod 2 = 0 or y(P) = p-y otherwise.</span>
    p.assertValidity();
    <span class="hljs-keyword">return</span> p;
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>Create tagged hash, convert it to bigint, reduce modulo-n.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">challenge</span>(<span class="hljs-params">...args</span>) </span>{
    <span class="hljs-keyword">return</span> modN((<span class="hljs-number">0</span>, utils_js_1.bytesToNumberBE)(taggedHash(<span class="hljs-string">'BIP0340/challenge'</span>, ...args)));
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>Schnorr public key is just <code>x</code> coordinate of Point as per BIP340.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schnorrGetPublicKey</span>(<span class="hljs-params">privateKey</span>) </span>{
    <span class="hljs-keyword">return</span> schnorrGetExtPubKey(privateKey).bytes; <span class="hljs-comment">// d'=int(sk). Fail if d'=0 or d'≥n. Ret bytes(d'⋅G)</span>
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<div class="dox">
<div class="summary">
<p>Creates Schnorr signature as per BIP340. Verifies itself before returning anything.
auxRand is optional and is not the sole source of k generation: bad CSPRNG won't be dangerous.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schnorrSign</span>(<span class="hljs-params">message, privateKey, auxRand = (<span class="hljs-number">0</span>, utils_1.randomBytes</span>)(<span class="hljs-params"><span class="hljs-number">32</span></span>)) </span>{
    <span class="hljs-keyword">const</span> m = (<span class="hljs-number">0</span>, utils_js_1.ensureBytes)(<span class="hljs-string">'message'</span>, message);
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">bytes</span>: px, <span class="hljs-attr">scalar</span>: d } = schnorrGetExtPubKey(privateKey); <span class="hljs-comment">// checks for isWithinCurveOrder</span>
    <span class="hljs-keyword">const</span> a = (<span class="hljs-number">0</span>, utils_js_1.ensureBytes)(<span class="hljs-string">'auxRand'</span>, auxRand, <span class="hljs-number">32</span>); <span class="hljs-comment">// Auxiliary random data a: a 32-byte array</span>
    <span class="hljs-keyword">const</span> t = numTo32b(d ^ (<span class="hljs-number">0</span>, utils_js_1.bytesToNumberBE)(taggedHash(<span class="hljs-string">'BIP0340/aux'</span>, a))); <span class="hljs-comment">// Let t be the byte-wise xor of bytes(d) and hash/aux(a)</span>
    <span class="hljs-keyword">const</span> rand = taggedHash(<span class="hljs-string">'BIP0340/nonce'</span>, t, px, m); <span class="hljs-comment">// Let rand = hash/nonce(t || bytes(P) || m)</span>
    <span class="hljs-keyword">const</span> k_ = modN((<span class="hljs-number">0</span>, utils_js_1.bytesToNumberBE)(rand)); <span class="hljs-comment">// Let k' = int(rand) mod n</span>
    <span class="hljs-keyword">if</span> (k_ === _0n)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'sign failed: k is zero'</span>); <span class="hljs-comment">// Fail if k' = 0.</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">bytes</span>: rx, <span class="hljs-attr">scalar</span>: k } = schnorrGetExtPubKey(k_); <span class="hljs-comment">// Let R = k'⋅G.</span>
    <span class="hljs-keyword">const</span> e = challenge(rx, px, m); <span class="hljs-comment">// Let e = int(hash/challenge(bytes(R) || bytes(P) || m)) mod n.</span>
    <span class="hljs-keyword">const</span> sig = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-number">64</span>); <span class="hljs-comment">// Let sig = bytes(R) || bytes((k + ed) mod n).</span>
    sig.set(rx, <span class="hljs-number">0</span>);
    sig.set(numTo32b(modN(k + e * d)), <span class="hljs-number">32</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>If Verify(bytes(P), m, sig) (see below) returns failure, abort</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!schnorrVerify(sig, m, px))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'sign: Invalid signature produced'</span>);
    <span class="hljs-keyword">return</span> sig;
}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<div class="dox">
<div class="summary">
<p>Verifies Schnorr signature.
Will swallow errors &amp; return false except for initial type validation of arguments.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schnorrVerify</span>(<span class="hljs-params">signature, message, publicKey</span>) </span>{
    <span class="hljs-keyword">const</span> sig = (<span class="hljs-number">0</span>, utils_js_1.ensureBytes)(<span class="hljs-string">'signature'</span>, signature, <span class="hljs-number">64</span>);
    <span class="hljs-keyword">const</span> m = (<span class="hljs-number">0</span>, utils_js_1.ensureBytes)(<span class="hljs-string">'message'</span>, message);
    <span class="hljs-keyword">const</span> pub = (<span class="hljs-number">0</span>, utils_js_1.ensureBytes)(<span class="hljs-string">'publicKey'</span>, publicKey, <span class="hljs-number">32</span>);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> P = lift_x((<span class="hljs-number">0</span>, utils_js_1.bytesToNumberBE)(pub)); <span class="hljs-comment">// P = lift_x(int(pk)); fail if that fails</span>
        <span class="hljs-keyword">const</span> r = (<span class="hljs-number">0</span>, utils_js_1.bytesToNumberBE)(sig.subarray(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>)); <span class="hljs-comment">// Let r = int(sig[0:32]); fail if r ≥ p.</span>
        <span class="hljs-keyword">if</span> (!fe(r))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">const</span> s = (<span class="hljs-number">0</span>, utils_js_1.bytesToNumberBE)(sig.subarray(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>)); <span class="hljs-comment">// Let s = int(sig[32:64]); fail if s ≥ n.</span>
        <span class="hljs-keyword">if</span> (!ge(s))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">const</span> e = challenge(numTo32b(r), pointToBytes(P), m); <span class="hljs-comment">// int(challenge(bytes(r)||bytes(P)||m))%n</span>
        <span class="hljs-keyword">const</span> R = GmulAdd(P, s, modN(-e)); <span class="hljs-comment">// R = s⋅G - e⋅P</span>
        <span class="hljs-keyword">if</span> (!R || !R.hasEvenY() || R.toAffine().x !== r)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// -eP == (n-e)P</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Fail if is_infinite(R) / not has_even_y(R) / x(R) ≠ r.</span>
    }
    <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
exports.schnorr = <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> ({
    <span class="hljs-attr">getPublicKey</span>: schnorrGetPublicKey,
    <span class="hljs-attr">sign</span>: schnorrSign,
    <span class="hljs-attr">verify</span>: schnorrVerify,
    <span class="hljs-attr">utils</span>: {
        <span class="hljs-attr">randomPrivateKey</span>: exports.secp256k1.utils.randomPrivateKey,
        lift_x,
        pointToBytes,
        <span class="hljs-attr">numberToBytesBE</span>: utils_js_1.numberToBytesBE,
        <span class="hljs-attr">bytesToNumberBE</span>: utils_js_1.bytesToNumberBE,
        taggedHash,
        <span class="hljs-attr">mod</span>: modular_js_1.mod,
    },
}))();
<span class="hljs-keyword">const</span> isoMap = <span class="hljs-comment">/* @__PURE__ */</span> <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> (<span class="hljs-number">0</span>, hash_to_curve_js_1.isogenyMap)(Fp, [
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>xNum</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    [
        <span class="hljs-string">'0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa8c7'</span>,
        <span class="hljs-string">'0x7d3d4c80bc321d5b9f315cea7fd44c5d595d2fc0bf63b92dfff1044f17c6581'</span>,
        <span class="hljs-string">'0x534c328d23f234e6e2a413deca25caece4506144037c40314ecbd0b53d9dd262'</span>,
        <span class="hljs-string">'0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa88c'</span>,
    ],
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>xDen</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    [
        <span class="hljs-string">'0xd35771193d94918a9ca34ccbb7b640dd86cd409542f8487d9fe6b745781eb49b'</span>,
        <span class="hljs-string">'0xedadc6f64383dc1df7c4b2d51b54225406d36b641f5e41bbc52a56612a8c6d14'</span>,
        <span class="hljs-string">'0x0000000000000000000000000000000000000000000000000000000000000001'</span>, <span class="hljs-comment">// LAST 1</span>
    ],
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>yNum</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    [
        <span class="hljs-string">'0x4bda12f684bda12f684bda12f684bda12f684bda12f684bda12f684b8e38e23c'</span>,
        <span class="hljs-string">'0xc75e0c32d5cb7c0fa9d0a54b12a0a6d5647ab046d686da6fdffc90fc201d71a3'</span>,
        <span class="hljs-string">'0x29a6194691f91a73715209ef6512e576722830a201be2018a765e85a9ecee931'</span>,
        <span class="hljs-string">'0x2f684bda12f684bda12f684bda12f684bda12f684bda12f684bda12f38e38d84'</span>,
    ],
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>yDen</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    [
        <span class="hljs-string">'0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffff93b'</span>,
        <span class="hljs-string">'0x7a06534bb8bdb49fd5e9e6632722c2989467c1bfc8e8d978dfb425d2685c2573'</span>,
        <span class="hljs-string">'0x6484aa716545ca2cf3a70c3fa8fe337e0a3d21162f0d6299a7bf8192bfd2a76f'</span>,
        <span class="hljs-string">'0x0000000000000000000000000000000000000000000000000000000000000001'</span>, <span class="hljs-comment">// LAST 1</span>
    ],
].map(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> i.map(<span class="hljs-function">(<span class="hljs-params">j</span>) =&gt;</span> BigInt(j)))))();
<span class="hljs-keyword">const</span> mapSWU = <span class="hljs-comment">/* @__PURE__ */</span> <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> (<span class="hljs-number">0</span>, weierstrass_js_1.mapToCurveSimpleSWU)(Fp, {
    <span class="hljs-attr">A</span>: BigInt(<span class="hljs-string">'0x3f8731abdd661adca08a5558f0f5d272e953d363cb6f0e5d405447c01a444533'</span>),
    <span class="hljs-attr">B</span>: BigInt(<span class="hljs-string">'1771'</span>),
    <span class="hljs-attr">Z</span>: Fp.create(BigInt(<span class="hljs-string">'-11'</span>)),
}))();
<span class="hljs-keyword">const</span> htf = <span class="hljs-comment">/* @__PURE__ */</span> <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-number">0</span>, hash_to_curve_js_1.createHasher</span>)(<span class="hljs-params">exports.secp256k1.ProjectivePoint, (scalars</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { x, y } = mapSWU(Fp.create(scalars[<span class="hljs-number">0</span>]));
    <span class="hljs-keyword">return</span> isoMap(x, y);
}, {
    <span class="hljs-attr">DST</span>: <span class="hljs-string">'secp256k1_XMD:SHA-256_SSWU_RO_'</span>,
    <span class="hljs-attr">encodeDST</span>: <span class="hljs-string">'secp256k1_XMD:SHA-256_SSWU_NU_'</span>,
    <span class="hljs-attr">p</span>: Fp.ORDER,
    <span class="hljs-attr">m</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">k</span>: <span class="hljs-number">128</span>,
    <span class="hljs-attr">expand</span>: <span class="hljs-string">'xmd'</span>,
    <span class="hljs-attr">hash</span>: sha256_1.sha256,
}))();
exports.hashToCurve = <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> htf.hashToCurve)();
exports.encodeToCurve = <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> htf.encodeToCurve)();
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="sourcemappingurlsecp256k1.js.map">
  <h1>
    <a href="#sourcemappingurlsecp256k1.js.map" name="sourcemappingurlsecp256k1.js.map" class="pilcrow"></a>
sourceMappingURL=secp256k1.js.map
  </h1>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"></pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
