<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/url-parse/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">var</span> required = <span class="hljs-built_in">require</span>(<span class="hljs-string">'requires-port'</span>)
  , qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'querystringify'</span>)
  , controlOrWhitespace = <span class="hljs-regexp">/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/</span>
  , CRHTLF = <span class="hljs-regexp">/[\n\r\t]/g</span>
  , slashes = <span class="hljs-regexp">/^[A-Za-z][A-Za-z0-9+-.]*:\/\//</span>
  , port = <span class="hljs-regexp">/:\d+$/</span>
  , protocolre = <span class="hljs-regexp">/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\\/]+)?([\S\s]*)/i</span>
  , windowsDriveLetter = <span class="hljs-regexp">/^[a-zA-Z]:/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Remove control characters and whitespace from the beginning of a string.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">str</span>
<span class="dox_type">Object</span>
<span class="dox_type">String</span>
<span>String to trim.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trimLeft</span>(<span class="hljs-params">str</span>) </span>{
  <span class="hljs-keyword">return</span> (str ? str : <span class="hljs-string">''</span>).toString().replace(controlOrWhitespace, <span class="hljs-string">''</span>);
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>These are the parse rules for the URL parser, it informs the parser
about:</p>
</div>
<div class="body">
<ol start="0">
<li>The char it Needs to parse, if it's a string it should be done using
indexOf, RegExp using exec and NaN means set as current value.</li>
<li>The property we should set when parsing this value.</li>
<li>Indication if it's backwards or forward parsing, when set as number it's
the value of extra chars that should be split off.</li>
<li>Inherit from location if non existing in the parser.</li>
<li><code>toLowerCase</code> the resulting value.</li>
</ol>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> rules = [
  [<span class="hljs-string">'#'</span>, <span class="hljs-string">'hash'</span>],                        <span class="hljs-comment">// Extract from the back.</span>
  [<span class="hljs-string">'?'</span>, <span class="hljs-string">'query'</span>],                       <span class="hljs-comment">// Extract from the back.</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sanitize</span>(<span class="hljs-params">address, url</span>) </span>{     <span class="hljs-comment">// Sanitize what is left of the address</span>
    <span class="hljs-keyword">return</span> isSpecial(url.protocol) ? address.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>) : address;
  },
  [<span class="hljs-string">'/'</span>, <span class="hljs-string">'pathname'</span>],                    <span class="hljs-comment">// Extract from the back.</span>
  [<span class="hljs-string">'@'</span>, <span class="hljs-string">'auth'</span>, <span class="hljs-number">1</span>],                     <span class="hljs-comment">// Extract from the front.</span>
  [<span class="hljs-literal">NaN</span>, <span class="hljs-string">'host'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],       <span class="hljs-comment">// Set left over value.</span>
  [<span class="hljs-regexp">/:(\d*)$/</span>, <span class="hljs-string">'port'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">1</span>],    <span class="hljs-comment">// RegExp the back.</span>
  [<span class="hljs-literal">NaN</span>, <span class="hljs-string">'hostname'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]    <span class="hljs-comment">// Set left over.</span>
];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>These properties should not be copied or inherited from. This is only needed
for all non blob URL's as a blob URL does not include a hash, only the
origin.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Type</div>
<div class="dox_tag_detail">
<span class="dox_type">Object</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> ignore = { <span class="hljs-attr">hash</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">query</span>: <span class="hljs-number">1</span> };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>The location object differs when your code is loaded through a normal page,
Worker or through a worker using a blob. And with the blobble begins the
trouble as the location object will contain the URL of the blob, not the
location of the page where our code is loaded in. The actual origin is
encoded in the <code>pathname</code> so we can thankfully generate a good &quot;default&quot;
location from it so we can generate proper relative URL's again.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">loc</span>
<span class="dox_type">Object</span>
<span class="dox_type">String</span>
<span>Optional default location object.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lolcation</span>(<span class="hljs-params">loc</span>) </span>{
  <span class="hljs-keyword">var</span> globalVar;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span>) globalVar = <span class="hljs-built_in">window</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> global !== <span class="hljs-string">'undefined'</span>) globalVar = global;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> self !== <span class="hljs-string">'undefined'</span>) globalVar = self;
  <span class="hljs-keyword">else</span> globalVar = {};

  <span class="hljs-keyword">var</span> location = globalVar.location || {};
  loc = loc || location;

  <span class="hljs-keyword">var</span> finaldestination = {}
    , type = <span class="hljs-keyword">typeof</span> loc
    , key;

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'blob:'</span> === loc.protocol) {
    finaldestination = <span class="hljs-keyword">new</span> Url(<span class="hljs-built_in">unescape</span>(loc.pathname), {});
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === type) {
    finaldestination = <span class="hljs-keyword">new</span> Url(loc, {});
    <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> ignore) <span class="hljs-keyword">delete</span> finaldestination[key];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> === type) {
    <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> loc) {
      <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> ignore) <span class="hljs-keyword">continue</span>;
      finaldestination[key] = loc[key];
    }

    <span class="hljs-keyword">if</span> (finaldestination.slashes === <span class="hljs-literal">undefined</span>) {
      finaldestination.slashes = slashes.test(loc.href);
    }
  }

  <span class="hljs-keyword">return</span> finaldestination;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>Check whether a protocol scheme is special.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">The</span>
<span class="dox_type">String</span>
<span>protocol scheme of the URL
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Boolean</span>
<span><code>true</code> if the protocol scheme is special, else <code>false</code>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isSpecial</span>(<span class="hljs-params">scheme</span>) </span>{
  <span class="hljs-keyword">return</span> (
    scheme === <span class="hljs-string">'file:'</span> ||
    scheme === <span class="hljs-string">'ftp:'</span> ||
    scheme === <span class="hljs-string">'http:'</span> ||
    scheme === <span class="hljs-string">'https:'</span> ||
    scheme === <span class="hljs-string">'ws:'</span> ||
    scheme === <span class="hljs-string">'wss:'</span>
  );
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Type</div>
<div class="dox_tag_detail">
<span class="dox_type">bjec</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>Extract protocol information from a URL with/without double slash (&quot;//&quot;).</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">address</span>
<span class="dox_type">String</span>
<span>URL we want to extract from.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">location</span>
<span class="dox_type">Object</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">ProtocolExtract</span>
<span>Extracted information.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extractProtocol</span>(<span class="hljs-params">address, location</span>) </span>{
  address = trimLeft(address);
  address = address.replace(CRHTLF, <span class="hljs-string">''</span>);
  location = location || {};

  <span class="hljs-keyword">var</span> match = protocolre.exec(address);
  <span class="hljs-keyword">var</span> protocol = match[<span class="hljs-number">1</span>] ? match[<span class="hljs-number">1</span>].toLowerCase() : <span class="hljs-string">''</span>;
  <span class="hljs-keyword">var</span> forwardSlashes = !!match[<span class="hljs-number">2</span>];
  <span class="hljs-keyword">var</span> otherSlashes = !!match[<span class="hljs-number">3</span>];
  <span class="hljs-keyword">var</span> slashesCount = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> rest;

  <span class="hljs-keyword">if</span> (forwardSlashes) {
    <span class="hljs-keyword">if</span> (otherSlashes) {
      rest = match[<span class="hljs-number">2</span>] + match[<span class="hljs-number">3</span>] + match[<span class="hljs-number">4</span>];
      slashesCount = match[<span class="hljs-number">2</span>].length + match[<span class="hljs-number">3</span>].length;
    } <span class="hljs-keyword">else</span> {
      rest = match[<span class="hljs-number">2</span>] + match[<span class="hljs-number">4</span>];
      slashesCount = match[<span class="hljs-number">2</span>].length;
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (otherSlashes) {
      rest = match[<span class="hljs-number">3</span>] + match[<span class="hljs-number">4</span>];
      slashesCount = match[<span class="hljs-number">3</span>].length;
    } <span class="hljs-keyword">else</span> {
      rest = match[<span class="hljs-number">4</span>]
    }
  }

  <span class="hljs-keyword">if</span> (protocol === <span class="hljs-string">'file:'</span>) {
    <span class="hljs-keyword">if</span> (slashesCount &gt;= <span class="hljs-number">2</span>) {
      rest = rest.slice(<span class="hljs-number">2</span>);
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isSpecial(protocol)) {
    rest = match[<span class="hljs-number">4</span>];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (protocol) {
    <span class="hljs-keyword">if</span> (forwardSlashes) {
      rest = rest.slice(<span class="hljs-number">2</span>);
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slashesCount &gt;= <span class="hljs-number">2</span> &amp;&amp; isSpecial(location.protocol)) {
    rest = match[<span class="hljs-number">4</span>];
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">protocol</span>: protocol,
    <span class="hljs-attr">slashes</span>: forwardSlashes || isSpecial(protocol),
    <span class="hljs-attr">slashesCount</span>: slashesCount,
    <span class="hljs-attr">rest</span>: rest
  };
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>Resolve a relative URL pathname against a base URL pathname.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">relative</span>
<span class="dox_type">String</span>
<span>Pathname of the relative URL.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">base</span>
<span class="dox_type">String</span>
<span>Pathname of the base URL.
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">String</span>
<span>Resolved pathname.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">relative, base</span>) </span>{
  <span class="hljs-keyword">if</span> (relative === <span class="hljs-string">''</span>) <span class="hljs-keyword">return</span> base;

  <span class="hljs-keyword">var</span> path = (base || <span class="hljs-string">'/'</span>).split(<span class="hljs-string">'/'</span>).slice(<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>).concat(relative.split(<span class="hljs-string">'/'</span>))
    , i = path.length
    , last = path[i - <span class="hljs-number">1</span>]
    , unshift = <span class="hljs-literal">false</span>
    , up = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">while</span> (i--) {
    <span class="hljs-keyword">if</span> (path[i] === <span class="hljs-string">'.'</span>) {
      path.splice(i, <span class="hljs-number">1</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path[i] === <span class="hljs-string">'..'</span>) {
      path.splice(i, <span class="hljs-number">1</span>);
      up++;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (up) {
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) unshift = <span class="hljs-literal">true</span>;
      path.splice(i, <span class="hljs-number">1</span>);
      up--;
    }
  }

  <span class="hljs-keyword">if</span> (unshift) path.unshift(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">if</span> (last === <span class="hljs-string">'.'</span> || last === <span class="hljs-string">'..'</span>) path.push(<span class="hljs-string">''</span>);

  <span class="hljs-keyword">return</span> path.join(<span class="hljs-string">'/'</span>);
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>The actual URL instance. Instead of returning an object we've opted-in to
create an actual constructor as it's much more memory efficient and
faster and it pleases my OCD.</p>
</div>
<div class="body">
<p>It is worth noting that we should not use <code>URL</code> as class name to prevent
clashes with the global URL instance that got introduced in browsers.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">address</span>
<span class="dox_type">String</span>
<span>URL we want to parse.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[location]</span>
<span class="dox_type">Object</span>
<span class="dox_type">String</span>
<span>Location defaults for relative paths.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[parser]</span>
<span class="dox_type">Boolean</span>
<span class="dox_type">Function</span>
<span>Parser for the query string.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Url</span>(<span class="hljs-params">address, location, parser</span>) </span>{
  address = trimLeft(address);
  address = address.replace(CRHTLF, <span class="hljs-string">''</span>);

  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Url)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Url(address, location, parser);
  }

  <span class="hljs-keyword">var</span> relative, extracted, parse, instruction, index, key
    , instructions = rules.slice()
    , type = <span class="hljs-keyword">typeof</span> location
    , url = <span class="hljs-keyword">this</span>
    , i = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>The following if statements allows this module two have compatibility with
2 different API:</p>
<ol>
<li>
<p>Node.js's <code>url.parse</code> api which accepts a URL, boolean as arguments
where the boolean indicates that the query string should also be parsed.</p>
</li>
<li>
<p>The <code>URL</code> interface of the browser which accepts a URL, object as
arguments. The supplied object will be used as default values / fall-back
for relative paths.</p>
</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> !== type &amp;&amp; <span class="hljs-string">'string'</span> !== type) {
    parser = location;
    location = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">if</span> (parser &amp;&amp; <span class="hljs-string">'function'</span> !== <span class="hljs-keyword">typeof</span> parser) parser = qs.parse;

  location = lolcation(location);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Extract protocol information before running the instructions.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  extracted = extractProtocol(address || <span class="hljs-string">''</span>, location);
  relative = !extracted.protocol &amp;&amp; !extracted.slashes;
  url.slashes = extracted.slashes || relative &amp;&amp; location.slashes;
  url.protocol = extracted.protocol || location.protocol || <span class="hljs-string">''</span>;
  address = extracted.rest;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>When the authority component is absent the URL starts with a path
component.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (
    extracted.protocol === <span class="hljs-string">'file:'</span> &amp;&amp; (
      extracted.slashesCount !== <span class="hljs-number">2</span> || windowsDriveLetter.test(address)) ||
    (!extracted.slashes &amp;&amp;
      (extracted.protocol ||
        extracted.slashesCount &lt; <span class="hljs-number">2</span> ||
        !isSpecial(url.protocol)))
  ) {
    instructions[<span class="hljs-number">3</span>] = [<span class="hljs-regexp">/(.*)/</span>, <span class="hljs-string">'pathname'</span>];
  }

  <span class="hljs-keyword">for</span> (; i &lt; instructions.length; i++) {
    instruction = instructions[i];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> instruction === <span class="hljs-string">'function'</span>) {
      address = instruction(address, url);
      <span class="hljs-keyword">continue</span>;
    }

    parse = instruction[<span class="hljs-number">0</span>];
    key = instruction[<span class="hljs-number">1</span>];

    <span class="hljs-keyword">if</span> (parse !== parse) {
      url[key] = address;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> parse) {
      index = parse === <span class="hljs-string">'@'</span>
        ? address.lastIndexOf(parse)
        : address.indexOf(parse);

      <span class="hljs-keyword">if</span> (~index) {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">'number'</span> === <span class="hljs-keyword">typeof</span> instruction[<span class="hljs-number">2</span>]) {
          url[key] = address.slice(<span class="hljs-number">0</span>, index);
          address = address.slice(index + instruction[<span class="hljs-number">2</span>]);
        } <span class="hljs-keyword">else</span> {
          url[key] = address.slice(index);
          address = address.slice(<span class="hljs-number">0</span>, index);
        }
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((index = parse.exec(address))) {
      url[key] = index[<span class="hljs-number">1</span>];
      address = address.slice(<span class="hljs-number">0</span>, index.index);
    }

    url[key] = url[key] || (
      relative &amp;&amp; instruction[<span class="hljs-number">3</span>] ? location[key] || <span class="hljs-string">''</span> : <span class="hljs-string">''</span>
    );

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Hostname, host and protocol should be lowercased so they can be used to
create a proper <code>origin</code>.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (instruction[<span class="hljs-number">4</span>]) url[key] = url[key].toLowerCase();
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Also parse the supplied query string in to an object. If we're supplied
with a custom parser as function use that instead of the default build-in
parser.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (parser) url.query = parser(url.query);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>If the URL is relative, resolve the pathname against the base URL.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (
      relative
    &amp;&amp; location.slashes
    &amp;&amp; url.pathname.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">'/'</span>
    &amp;&amp; (url.pathname !== <span class="hljs-string">''</span> || location.pathname !== <span class="hljs-string">''</span>)
  ) {
    url.pathname = resolve(url.pathname, location.pathname);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Default to a / for pathname if none exists. This normalizes the URL
to always have a /</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (url.pathname.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">'/'</span> &amp;&amp; isSpecial(url.protocol)) {
    url.pathname = <span class="hljs-string">'/'</span> + url.pathname;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>We should not add port numbers if they are already the default port number
for a given protocol. As the host also contains the port number we're going
override it with the hostname which contains no port number.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!required(url.port, url.protocol)) {
    url.host = url.hostname;
    url.port = <span class="hljs-string">''</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Parse down the <code>auth</code> for the username and password.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  url.username = url.password = <span class="hljs-string">''</span>;

  <span class="hljs-keyword">if</span> (url.auth) {
    index = url.auth.indexOf(<span class="hljs-string">':'</span>);

    <span class="hljs-keyword">if</span> (~index) {
      url.username = url.auth.slice(<span class="hljs-number">0</span>, index);
      url.username = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(url.username));

      url.password = url.auth.slice(index + <span class="hljs-number">1</span>);
      url.password = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(url.password))
    } <span class="hljs-keyword">else</span> {
      url.username = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(url.auth));
    }

    url.auth = url.password ? url.username +<span class="hljs-string">':'</span>+ url.password : url.username;
  }

  url.origin = url.protocol !== <span class="hljs-string">'file:'</span> &amp;&amp; isSpecial(url.protocol) &amp;&amp; url.host
    ? url.protocol +<span class="hljs-string">'//'</span>+ url.host
    : <span class="hljs-string">'null'</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>The href is just the compiled result.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  url.href = url.toString();
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<div class="dox">
<div class="summary">
<p>This is convenience method for changing properties in the URL instance to
insure that they all propagate correctly.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">part</span>
<span class="dox_type">String</span>
<span>Property we need to adjust.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">value</span>
<span class="dox_type">Mixed</span>
<span>The newly assigned value.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">fn</span>
<span class="dox_type">Boolean</span>
<span class="dox_type">Function</span>
<span>When setting the query, it will be the function                               used to parse the query.
When setting the protocol, double slash will be
removed from the final url if it is true.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params">part, value, fn</span>) </span>{
  <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">switch</span> (part) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'query'</span>:
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> value &amp;&amp; value.length) {
        value = (fn || qs.parse)(value);
      }

      url[part] = value;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'port'</span>:
      url[part] = value;

      <span class="hljs-keyword">if</span> (!required(value, url.protocol)) {
        url.host = url.hostname;
        url[part] = <span class="hljs-string">''</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value) {
        url.host = url.hostname +<span class="hljs-string">':'</span>+ value;
      }

      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'hostname'</span>:
      url[part] = value;

      <span class="hljs-keyword">if</span> (url.port) value += <span class="hljs-string">':'</span>+ url.port;
      url.host = value;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'host'</span>:
      url[part] = value;

      <span class="hljs-keyword">if</span> (port.test(value)) {
        value = value.split(<span class="hljs-string">':'</span>);
        url.port = value.pop();
        url.hostname = value.join(<span class="hljs-string">':'</span>);
      } <span class="hljs-keyword">else</span> {
        url.hostname = value;
        url.port = <span class="hljs-string">''</span>;
      }

      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'protocol'</span>:
      url.protocol = value.toLowerCase();
      url.slashes = !fn;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'pathname'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'hash'</span>:
      <span class="hljs-keyword">if</span> (value) {
        <span class="hljs-keyword">var</span> char = part === <span class="hljs-string">'pathname'</span> ? <span class="hljs-string">'/'</span> : <span class="hljs-string">'#'</span>;
        url[part] = value.charAt(<span class="hljs-number">0</span>) !== char ? char + value : value;
      } <span class="hljs-keyword">else</span> {
        url[part] = value;
      }
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'username'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'password'</span>:
      url[part] = <span class="hljs-built_in">encodeURIComponent</span>(value);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'auth'</span>:
      <span class="hljs-keyword">var</span> index = value.indexOf(<span class="hljs-string">':'</span>);

      <span class="hljs-keyword">if</span> (~index) {
        url.username = value.slice(<span class="hljs-number">0</span>, index);
        url.username = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(url.username));

        url.password = value.slice(index + <span class="hljs-number">1</span>);
        url.password = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(url.password));
      } <span class="hljs-keyword">else</span> {
        url.username = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(value));
      }
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; rules.length; i++) {
    <span class="hljs-keyword">var</span> ins = rules[i];

    <span class="hljs-keyword">if</span> (ins[<span class="hljs-number">4</span>]) url[ins[<span class="hljs-number">1</span>]] = url[ins[<span class="hljs-number">1</span>]].toLowerCase();
  }

  url.auth = url.password ? url.username +<span class="hljs-string">':'</span>+ url.password : url.username;

  url.origin = url.protocol !== <span class="hljs-string">'file:'</span> &amp;&amp; isSpecial(url.protocol) &amp;&amp; url.host
    ? url.protocol +<span class="hljs-string">'//'</span>+ url.host
    : <span class="hljs-string">'null'</span>;

  url.href = url.toString();

  <span class="hljs-keyword">return</span> url;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<div class="dox">
<div class="summary">
<p>Transform the properties back in to a valid and full URL string.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">stringify</span>
<span class="dox_type">Function</span>
<span>Optional query stringify function.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toString</span>(<span class="hljs-params">stringify</span>) </span>{
  <span class="hljs-keyword">if</span> (!stringify || <span class="hljs-string">'function'</span> !== <span class="hljs-keyword">typeof</span> stringify) stringify = qs.stringify;

  <span class="hljs-keyword">var</span> query
    , url = <span class="hljs-keyword">this</span>
    , host = url.host
    , protocol = url.protocol;

  <span class="hljs-keyword">if</span> (protocol &amp;&amp; protocol.charAt(protocol.length - <span class="hljs-number">1</span>) !== <span class="hljs-string">':'</span>) protocol += <span class="hljs-string">':'</span>;

  <span class="hljs-keyword">var</span> result =
    protocol +
    ((url.protocol &amp;&amp; url.slashes) || isSpecial(url.protocol) ? <span class="hljs-string">'//'</span> : <span class="hljs-string">''</span>);

  <span class="hljs-keyword">if</span> (url.username) {
    result += url.username;
    <span class="hljs-keyword">if</span> (url.password) result += <span class="hljs-string">':'</span>+ url.password;
    result += <span class="hljs-string">'@'</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url.password) {
    result += <span class="hljs-string">':'</span>+ url.password;
    result += <span class="hljs-string">'@'</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
    url.protocol !== <span class="hljs-string">'file:'</span> &amp;&amp;
    isSpecial(url.protocol) &amp;&amp;
    !host &amp;&amp;
    url.pathname !== <span class="hljs-string">'/'</span>
  ) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Add back the empty userinfo, otherwise the original invalid URL
might be transformed into a valid one with <code>url.pathname</code> as host.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    result += <span class="hljs-string">'@'</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Trailing colon is removed from <code>url.host</code> when it is parsed. If it still
ends with a colon, then add back the trailing colon that was removed. This
prevents an invalid URL from being transformed into a valid one.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (host[host.length - <span class="hljs-number">1</span>] === <span class="hljs-string">':'</span> || (port.test(url.hostname) &amp;&amp; !url.port)) {
    host += <span class="hljs-string">':'</span>;
  }

  result += host + url.pathname;

  query = <span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> url.query ? stringify(url.query) : url.query;
  <span class="hljs-keyword">if</span> (query) result += <span class="hljs-string">'?'</span> !== query.charAt(<span class="hljs-number">0</span>) ? <span class="hljs-string">'?'</span>+ query : query;

  <span class="hljs-keyword">if</span> (url.hash) result += url.hash;

  <span class="hljs-keyword">return</span> result;
}

Url.prototype = { <span class="hljs-attr">set</span>: <span class="hljs-keyword">set</span>, toString: toString };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>Expose the URL parser and some additional properties that might be useful for
others or testing.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Url.extractProtocol = extractProtocol;
Url.location = lolcation;
Url.trimLeft = trimLeft;
Url.qs = qs;

<span class="hljs-built_in">module</span>.exports = Url;

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
