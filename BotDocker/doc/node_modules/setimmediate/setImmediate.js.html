<!DOCTYPE html>
<html>
<head>
  <title>setImmediate.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/setimmediate/setImmediate.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>setImmediate.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">global, undefined</span>) </span>{
    <span class="hljs-string">"use strict"</span>;

    <span class="hljs-keyword">if</span> (global.setImmediate) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> nextHandle = <span class="hljs-number">1</span>; <span class="hljs-comment">// Spec says greater than zero</span>
    <span class="hljs-keyword">var</span> tasksByHandle = {};
    <span class="hljs-keyword">var</span> currentlyRunningATask = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> doc = global.document;
    <span class="hljs-keyword">var</span> registerImmediate;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setImmediate</span>(<span class="hljs-params">callback</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Callback can either be a function or a string</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
        callback = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">""</span> + callback);
      }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Copy function arguments</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-built_in">arguments</span>.length - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {
          args[i] = <span class="hljs-built_in">arguments</span>[i + <span class="hljs-number">1</span>];
      }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Store and register the task</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">var</span> task = { <span class="hljs-attr">callback</span>: callback, <span class="hljs-attr">args</span>: args };
      tasksByHandle[nextHandle] = task;
      registerImmediate(nextHandle);
      <span class="hljs-keyword">return</span> nextHandle++;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearImmediate</span>(<span class="hljs-params">handle</span>) </span>{
        <span class="hljs-keyword">delete</span> tasksByHandle[handle];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">task</span>) </span>{
        <span class="hljs-keyword">var</span> callback = task.callback;
        <span class="hljs-keyword">var</span> args = task.args;
        <span class="hljs-keyword">switch</span> (args.length) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            callback();
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
            callback(args[<span class="hljs-number">0</span>]);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
            callback(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>]);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
            callback(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>], args[<span class="hljs-number">2</span>]);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            callback.apply(<span class="hljs-literal">undefined</span>, args);
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runIfPresent</span>(<span class="hljs-params">handle</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>From the spec: &quot;Wait until any invocations of this algorithm started before this one have completed.&quot;
So if we're currently running a task, we'll need to delay this invocation.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (currentlyRunningATask) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Delay by doing a setTimeout. setImmediate was tried instead, but in Firefox 7 it generated a
&quot;too much recursion&quot; error.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            setTimeout(runIfPresent, <span class="hljs-number">0</span>, handle);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> task = tasksByHandle[handle];
            <span class="hljs-keyword">if</span> (task) {
                currentlyRunningATask = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">try</span> {
                    run(task);
                } <span class="hljs-keyword">finally</span> {
                    clearImmediate(handle);
                    currentlyRunningATask = <span class="hljs-literal">false</span>;
                }
            }
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">installNextTickImplementation</span>(<span class="hljs-params"></span>) </span>{
        registerImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handle</span>) </span>{
            process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ runIfPresent(handle); });
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canUsePostMessage</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>The test against <code>importScripts</code> prevents this implementation from being installed inside a web worker,
where <code>global.postMessage</code> means something completely different and can't be used for this purpose.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (global.postMessage &amp;&amp; !global.importScripts) {
            <span class="hljs-keyword">var</span> postMessageIsAsynchronous = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">var</span> oldOnMessage = global.onmessage;
            global.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                postMessageIsAsynchronous = <span class="hljs-literal">false</span>;
            };
            global.postMessage(<span class="hljs-string">""</span>, <span class="hljs-string">"*"</span>);
            global.onmessage = oldOnMessage;
            <span class="hljs-keyword">return</span> postMessageIsAsynchronous;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">installPostMessageImplementation</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Installs an event handler on <code>global</code> for the <code>message</code> event: see</p>
<ul>
<li>https://developer.mozilla.org/en/DOM/window.postMessage</li>
<li>http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html#crossDocumentMessages</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">var</span> messagePrefix = <span class="hljs-string">"setImmediate$"</span> + <span class="hljs-built_in">Math</span>.random() + <span class="hljs-string">"$"</span>;
        <span class="hljs-keyword">var</span> onGlobalMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
            <span class="hljs-keyword">if</span> (event.source === global &amp;&amp;
                <span class="hljs-keyword">typeof</span> event.data === <span class="hljs-string">"string"</span> &amp;&amp;
                event.data.indexOf(messagePrefix) === <span class="hljs-number">0</span>) {
                runIfPresent(+event.data.slice(messagePrefix.length));
            }
        };

        <span class="hljs-keyword">if</span> (global.addEventListener) {
            global.addEventListener(<span class="hljs-string">"message"</span>, onGlobalMessage, <span class="hljs-literal">false</span>);
        } <span class="hljs-keyword">else</span> {
            global.attachEvent(<span class="hljs-string">"onmessage"</span>, onGlobalMessage);
        }

        registerImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handle</span>) </span>{
            global.postMessage(messagePrefix + handle, <span class="hljs-string">"*"</span>);
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">installMessageChannelImplementation</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> channel = <span class="hljs-keyword">new</span> MessageChannel();
        channel.port1.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
            <span class="hljs-keyword">var</span> handle = event.data;
            runIfPresent(handle);
        };

        registerImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handle</span>) </span>{
            channel.port2.postMessage(handle);
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">installReadyStateChangeImplementation</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> html = doc.documentElement;
        registerImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handle</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Create a <script> element; its readystatechange event will be fired asynchronously once it is inserted
into the document. Do so, thus queuing up the task. Remember to clean up once it's been called.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">var</span> script = doc.createElement(<span class="hljs-string">"script"</span>);
            script.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                runIfPresent(handle);
                script.onreadystatechange = <span class="hljs-literal">null</span>;
                html.removeChild(script);
                script = <span class="hljs-literal">null</span>;
            };
            html.appendChild(script);
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">installSetTimeoutImplementation</span>(<span class="hljs-params"></span>) </span>{
        registerImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handle</span>) </span>{
            setTimeout(runIfPresent, <span class="hljs-number">0</span>, handle);
        };
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>If supported, we should attach to the prototype of global, since that is where setTimeout et al. live.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> attachTo = <span class="hljs-built_in">Object</span>.getPrototypeOf &amp;&amp; <span class="hljs-built_in">Object</span>.getPrototypeOf(global);
    attachTo = attachTo &amp;&amp; attachTo.setTimeout ? attachTo : global;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Don't get fooled by e.g. browserify environments.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> ({}.toString.call(global.process) === <span class="hljs-string">"[object process]"</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>For Node.js before 0.9</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        installNextTickImplementation();

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (canUsePostMessage()) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>For non-IE10 modern browsers</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        installPostMessageImplementation();

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (global.MessageChannel) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>For web workers, where supported</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        installMessageChannelImplementation();

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (doc &amp;&amp; <span class="hljs-string">"onreadystatechange"</span> <span class="hljs-keyword">in</span> doc.createElement(<span class="hljs-string">"script"</span>)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>For IE 6–8</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        installReadyStateChangeImplementation();

    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>For older browsers</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        installSetTimeoutImplementation();
    }

    attachTo.setImmediate = setImmediate;
    attachTo.clearImmediate = clearImmediate;
}(<span class="hljs-keyword">typeof</span> self === <span class="hljs-string">"undefined"</span> ? <span class="hljs-keyword">typeof</span> global === <span class="hljs-string">"undefined"</span> ? <span class="hljs-keyword">this</span> : global : self));

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
