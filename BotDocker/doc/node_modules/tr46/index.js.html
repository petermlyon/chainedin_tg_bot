<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/tr46/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">var</span> punycode = <span class="hljs-built_in">require</span>(<span class="hljs-string">"punycode"</span>);
<span class="hljs-keyword">var</span> mappingTable = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./lib/mappingTable.json"</span>);

<span class="hljs-keyword">var</span> PROCESSING_OPTIONS = {
  <span class="hljs-attr">TRANSITIONAL</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">NONTRANSITIONAL</span>: <span class="hljs-number">1</span>
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalize</span>(<span class="hljs-params">str</span>) </span>{ <span class="hljs-comment">// fix bug in v8</span>
  <span class="hljs-keyword">return</span> str.split(<span class="hljs-string">'\u0000'</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{ <span class="hljs-keyword">return</span> s.normalize(<span class="hljs-string">'NFC'</span>); }).join(<span class="hljs-string">'\u0000'</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findStatus</span>(<span class="hljs-params">val</span>) </span>{
  <span class="hljs-keyword">var</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> end = mappingTable.length - <span class="hljs-number">1</span>;

  <span class="hljs-keyword">while</span> (start &lt;= end) {
    <span class="hljs-keyword">var</span> mid = <span class="hljs-built_in">Math</span>.floor((start + end) / <span class="hljs-number">2</span>);

    <span class="hljs-keyword">var</span> target = mappingTable[mid];
    <span class="hljs-keyword">if</span> (target[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] &lt;= val &amp;&amp; target[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] &gt;= val) {
      <span class="hljs-keyword">return</span> target;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] &gt; val) {
      end = mid - <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
      start = mid + <span class="hljs-number">1</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">var</span> regexAstralSymbols = <span class="hljs-regexp">/[\uD800-\uDBFF][\uDC00-\uDFFF]/g</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countSymbols</span>(<span class="hljs-params">string</span>) </span>{
  <span class="hljs-keyword">return</span> string
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>replace every surrogate pair with a BMP symbol</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    .replace(regexAstralSymbols, <span class="hljs-string">'_'</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>then get the length</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    .length;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapChars</span>(<span class="hljs-params">domain_name, useSTD3, processing_option</span>) </span>{
  <span class="hljs-keyword">var</span> hasError = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> processed = <span class="hljs-string">""</span>;

  <span class="hljs-keyword">var</span> len = countSymbols(domain_name);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; ++i) {
    <span class="hljs-keyword">var</span> codePoint = domain_name.codePointAt(i);
    <span class="hljs-keyword">var</span> status = findStatus(codePoint);

    <span class="hljs-keyword">switch</span> (status[<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"disallowed"</span>:
        hasError = <span class="hljs-literal">true</span>;
        processed += <span class="hljs-built_in">String</span>.fromCodePoint(codePoint);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"ignored"</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"mapped"</span>:
        processed += <span class="hljs-built_in">String</span>.fromCodePoint.apply(<span class="hljs-built_in">String</span>, status[<span class="hljs-number">2</span>]);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"deviation"</span>:
        <span class="hljs-keyword">if</span> (processing_option === PROCESSING_OPTIONS.TRANSITIONAL) {
          processed += <span class="hljs-built_in">String</span>.fromCodePoint.apply(<span class="hljs-built_in">String</span>, status[<span class="hljs-number">2</span>]);
        } <span class="hljs-keyword">else</span> {
          processed += <span class="hljs-built_in">String</span>.fromCodePoint(codePoint);
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"valid"</span>:
        processed += <span class="hljs-built_in">String</span>.fromCodePoint(codePoint);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"disallowed_STD3_mapped"</span>:
        <span class="hljs-keyword">if</span> (useSTD3) {
          hasError = <span class="hljs-literal">true</span>;
          processed += <span class="hljs-built_in">String</span>.fromCodePoint(codePoint);
        } <span class="hljs-keyword">else</span> {
          processed += <span class="hljs-built_in">String</span>.fromCodePoint.apply(<span class="hljs-built_in">String</span>, status[<span class="hljs-number">2</span>]);
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"disallowed_STD3_valid"</span>:
        <span class="hljs-keyword">if</span> (useSTD3) {
          hasError = <span class="hljs-literal">true</span>;
        }

        processed += <span class="hljs-built_in">String</span>.fromCodePoint(codePoint);
        <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">string</span>: processed,
    <span class="hljs-attr">error</span>: hasError
  };
}

<span class="hljs-keyword">var</span> combiningMarksRegex = <span class="hljs-regexp">/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08E4-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C03\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D01-\u0D03\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u18A9\u1920-\u192B\u1930-\u193B\u19B0-\u19C0\u19C8\u19C9\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF8\u1CF9\u1DC0-\u1DF5\u1DFC-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C4\uA8E0-\uA8F1\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2D]|\uD800[\uDDFD\uDEE0\uDF76-\uDF7A]|\uD802[\uDE01-\uDE03\uDE05\uDE06\uDE0C-\uDE0F\uDE38-\uDE3A\uDE3F\uDEE5\uDEE6]|\uD804[\uDC00-\uDC02\uDC38-\uDC46\uDC7F-\uDC82\uDCB0-\uDCBA\uDD00-\uDD02\uDD27-\uDD34\uDD73\uDD80-\uDD82\uDDB3-\uDDC0\uDE2C-\uDE37\uDEDF-\uDEEA\uDF01-\uDF03\uDF3C\uDF3E-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF57\uDF62\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDCB0-\uDCC3\uDDAF-\uDDB5\uDDB8-\uDDC0\uDE30-\uDE40\uDEAB-\uDEB7]|\uD81A[\uDEF0-\uDEF4\uDF30-\uDF36]|\uD81B[\uDF51-\uDF7E\uDF8F-\uDF92]|\uD82F[\uDC9D\uDC9E]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD83A[\uDCD0-\uDCD6]|\uDB40[\uDD00-\uDDEF]/</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateLabel</span>(<span class="hljs-params">label, processing_option</span>) </span>{
  <span class="hljs-keyword">if</span> (label.substr(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>) === <span class="hljs-string">"xn--"</span>) {
    label = punycode.toUnicode(label);
    processing_option = PROCESSING_OPTIONS.NONTRANSITIONAL;
  }

  <span class="hljs-keyword">var</span> error = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (normalize(label) !== label ||
      (label[<span class="hljs-number">3</span>] === <span class="hljs-string">"-"</span> &amp;&amp; label[<span class="hljs-number">4</span>] === <span class="hljs-string">"-"</span>) ||
      label[<span class="hljs-number">0</span>] === <span class="hljs-string">"-"</span> || label[label.length - <span class="hljs-number">1</span>] === <span class="hljs-string">"-"</span> ||
      label.indexOf(<span class="hljs-string">"."</span>) !== <span class="hljs-number">-1</span> ||
      label.search(combiningMarksRegex) === <span class="hljs-number">0</span>) {
    error = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">var</span> len = countSymbols(label);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; ++i) {
    <span class="hljs-keyword">var</span> status = findStatus(label.codePointAt(i));
    <span class="hljs-keyword">if</span> ((processing === PROCESSING_OPTIONS.TRANSITIONAL &amp;&amp; status[<span class="hljs-number">1</span>] !== <span class="hljs-string">"valid"</span>) ||
        (processing === PROCESSING_OPTIONS.NONTRANSITIONAL &amp;&amp;
         status[<span class="hljs-number">1</span>] !== <span class="hljs-string">"valid"</span> &amp;&amp; status[<span class="hljs-number">1</span>] !== <span class="hljs-string">"deviation"</span>)) {
      error = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">label</span>: label,
    <span class="hljs-attr">error</span>: error
  };
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processing</span>(<span class="hljs-params">domain_name, useSTD3, processing_option</span>) </span>{
  <span class="hljs-keyword">var</span> result = mapChars(domain_name, useSTD3, processing_option);
  result.string = normalize(result.string);

  <span class="hljs-keyword">var</span> labels = result.string.split(<span class="hljs-string">"."</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; labels.length; ++i) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> validation = validateLabel(labels[i]);
      labels[i] = validation.label;
      result.error = result.error || validation.error;
    } <span class="hljs-keyword">catch</span>(e) {
      result.error = <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">string</span>: labels.join(<span class="hljs-string">"."</span>),
    <span class="hljs-attr">error</span>: result.error
  };
}

<span class="hljs-built_in">module</span>.exports.toASCII = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">domain_name, useSTD3, processing_option, verifyDnsLength</span>) </span>{
  <span class="hljs-keyword">var</span> result = processing(domain_name, useSTD3, processing_option);
  <span class="hljs-keyword">var</span> labels = result.string.split(<span class="hljs-string">"."</span>);
  labels = labels.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> punycode.toASCII(l);
    } <span class="hljs-keyword">catch</span>(e) {
      result.error = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span> l;
    }
  });

  <span class="hljs-keyword">if</span> (verifyDnsLength) {
    <span class="hljs-keyword">var</span> total = labels.slice(<span class="hljs-number">0</span>, labels.length - <span class="hljs-number">1</span>).join(<span class="hljs-string">"."</span>).length;
    <span class="hljs-keyword">if</span> (total.length &gt; <span class="hljs-number">253</span> || total.length === <span class="hljs-number">0</span>) {
      result.error = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &lt; labels.length; ++i) {
      <span class="hljs-keyword">if</span> (labels.length &gt; <span class="hljs-number">63</span> || labels.length === <span class="hljs-number">0</span>) {
        result.error = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">break</span>;
      }
    }
  }

  <span class="hljs-keyword">if</span> (result.error) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> labels.join(<span class="hljs-string">"."</span>);
};

<span class="hljs-built_in">module</span>.exports.toUnicode = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">domain_name, useSTD3</span>) </span>{
  <span class="hljs-keyword">var</span> result = processing(domain_name, useSTD3, PROCESSING_OPTIONS.NONTRANSITIONAL);

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">domain</span>: result.string,
    <span class="hljs-attr">error</span>: result.error
  };
};

<span class="hljs-built_in">module</span>.exports.PROCESSING_OPTIONS = PROCESSING_OPTIONS;

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
