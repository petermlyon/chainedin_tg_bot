<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/psl/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-comment">/*eslint no-var:0, prefer-arrow-callback: 0, object-shorthand: 0 */</span>
<span class="hljs-meta">'use strict'</span>;


<span class="hljs-keyword">var</span> Punycode = <span class="hljs-built_in">require</span>(<span class="hljs-string">'punycode'</span>);


<span class="hljs-keyword">var</span> internals = {};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Read rules from file.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">internals.rules = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./data/rules.json'</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rule</span>) </span>{

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">rule</span>: rule,
    <span class="hljs-attr">suffix</span>: rule.replace(<span class="hljs-regexp">/^(\*\.|\!)/</span>, <span class="hljs-string">''</span>),
    <span class="hljs-attr">punySuffix</span>: <span class="hljs-number">-1</span>,
    <span class="hljs-attr">wildcard</span>: rule.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'*'</span>,
    <span class="hljs-attr">exception</span>: rule.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'!'</span>
  };
});


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Check is given string ends with <code>suffix</code>.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">internals.endsWith = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">str, suffix</span>) </span>{

  <span class="hljs-keyword">return</span> str.indexOf(suffix, str.length - suffix.length) !== <span class="hljs-number">-1</span>;
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Find rule for a given domain.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">internals.findRule = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">domain</span>) </span>{

  <span class="hljs-keyword">var</span> punyDomain = Punycode.toASCII(domain);
  <span class="hljs-keyword">return</span> internals.rules.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">memo, rule</span>) </span>{

    <span class="hljs-keyword">if</span> (rule.punySuffix === <span class="hljs-number">-1</span>){
      rule.punySuffix = Punycode.toASCII(rule.suffix);
    }
    <span class="hljs-keyword">if</span> (!internals.endsWith(punyDomain, <span class="hljs-string">'.'</span> + rule.punySuffix) &amp;&amp; punyDomain !== rule.punySuffix) {
      <span class="hljs-keyword">return</span> memo;
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>This has been commented out as it never seems to run. This is because
sub tlds always appear after their parents and we never find a shorter
match.
if (memo) {
var memoSuffix = Punycode.toASCII(memo.suffix);
if (memoSuffix.length &gt;= punySuffix.length) {
return memo;
}
}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> rule;
  }, <span class="hljs-literal">null</span>);
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Error codes and messages.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">exports.errorCodes = {
  <span class="hljs-attr">DOMAIN_TOO_SHORT</span>: <span class="hljs-string">'Domain name too short.'</span>,
  <span class="hljs-attr">DOMAIN_TOO_LONG</span>: <span class="hljs-string">'Domain name too long. It should be no more than 255 chars.'</span>,
  <span class="hljs-attr">LABEL_STARTS_WITH_DASH</span>: <span class="hljs-string">'Domain name label can not start with a dash.'</span>,
  <span class="hljs-attr">LABEL_ENDS_WITH_DASH</span>: <span class="hljs-string">'Domain name label can not end with a dash.'</span>,
  <span class="hljs-attr">LABEL_TOO_LONG</span>: <span class="hljs-string">'Domain name label should be at most 63 chars long.'</span>,
  <span class="hljs-attr">LABEL_TOO_SHORT</span>: <span class="hljs-string">'Domain name label should be at least 1 character long.'</span>,
  <span class="hljs-attr">LABEL_INVALID_CHARS</span>: <span class="hljs-string">'Domain name label can only contain alphanumeric characters or dashes.'</span>
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Validate domain name and throw if not valid.</p>
<p>From wikipedia:</p>
<p>Hostnames are composed of series of labels concatenated with dots, as are all
domain names. Each label must be between 1 and 63 characters long, and the
entire hostname (including the delimiting dots) has a maximum of 255 chars.</p>
<p>Allowed chars:</p>
<ul>
<li>
<p><code>a-z</code></p>
</li>
<li>
<p><code>0-9</code></p>
</li>
<li>
<p><code>-</code> but not as a starting or ending character</p>
</li>
<li>
<p><code>.</code> as a separator for the textual portions of a domain name</p>
</li>
<li>
<p>http://en.wikipedia.org/wiki/Domain_name</p>
</li>
<li>
<p>http://en.wikipedia.org/wiki/Hostname</p>
</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="javascript">internals.validate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">input</span>) </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Before we can validate we need to take care of IDNs with unicode chars.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> ascii = Punycode.toASCII(input);

  <span class="hljs-keyword">if</span> (ascii.length &lt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'DOMAIN_TOO_SHORT'</span>;
  }
  <span class="hljs-keyword">if</span> (ascii.length &gt; <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'DOMAIN_TOO_LONG'</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Check each part's length and allowed chars.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> labels = ascii.split(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">var</span> label;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; labels.length; ++i) {
    label = labels[i];
    <span class="hljs-keyword">if</span> (!label.length) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'LABEL_TOO_SHORT'</span>;
    }
    <span class="hljs-keyword">if</span> (label.length &gt; <span class="hljs-number">63</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'LABEL_TOO_LONG'</span>;
    }
    <span class="hljs-keyword">if</span> (label.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'-'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'LABEL_STARTS_WITH_DASH'</span>;
    }
    <span class="hljs-keyword">if</span> (label.charAt(label.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'-'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'LABEL_ENDS_WITH_DASH'</span>;
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^[a-z0-9\-]+$/</span>.test(label)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'LABEL_INVALID_CHARS'</span>;
    }
  }
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Public API</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Parse domain.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">exports.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">input</span>) </span>{

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> input !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Domain name must be a string.'</span>);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Force domain to lowercase.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> domain = input.slice(<span class="hljs-number">0</span>).toLowerCase();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Handle FQDN.
TODO: Simply remove trailing dot?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (domain.charAt(domain.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'.'</span>) {
    domain = domain.slice(<span class="hljs-number">0</span>, domain.length - <span class="hljs-number">1</span>);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Validate and sanitise input.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> error = internals.validate(domain);
  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">input</span>: input,
      <span class="hljs-attr">error</span>: {
        <span class="hljs-attr">message</span>: exports.errorCodes[error],
        <span class="hljs-attr">code</span>: error
      }
    };
  }

  <span class="hljs-keyword">var</span> parsed = {
    <span class="hljs-attr">input</span>: input,
    <span class="hljs-attr">tld</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">sld</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">domain</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">subdomain</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">listed</span>: <span class="hljs-literal">false</span>
  };

  <span class="hljs-keyword">var</span> domainParts = domain.split(<span class="hljs-string">'.'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Non-Internet TLD</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (domainParts[domainParts.length - <span class="hljs-number">1</span>] === <span class="hljs-string">'local'</span>) {
    <span class="hljs-keyword">return</span> parsed;
  }

  <span class="hljs-keyword">var</span> handlePunycode = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/xn--/</span>.test(domain)) {
      <span class="hljs-keyword">return</span> parsed;
    }
    <span class="hljs-keyword">if</span> (parsed.domain) {
      parsed.domain = Punycode.toASCII(parsed.domain);
    }
    <span class="hljs-keyword">if</span> (parsed.subdomain) {
      parsed.subdomain = Punycode.toASCII(parsed.subdomain);
    }
    <span class="hljs-keyword">return</span> parsed;
  };

  <span class="hljs-keyword">var</span> rule = internals.findRule(domain);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Unlisted tld.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!rule) {
    <span class="hljs-keyword">if</span> (domainParts.length &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">return</span> parsed;
    }
    parsed.tld = domainParts.pop();
    parsed.sld = domainParts.pop();
    parsed.domain = [parsed.sld, parsed.tld].join(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">if</span> (domainParts.length) {
      parsed.subdomain = domainParts.pop();
    }
    <span class="hljs-keyword">return</span> handlePunycode();
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>At this point we know the public suffix is listed.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  parsed.listed = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">var</span> tldParts = rule.suffix.split(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">var</span> privateParts = domainParts.slice(<span class="hljs-number">0</span>, domainParts.length - tldParts.length);

  <span class="hljs-keyword">if</span> (rule.exception) {
    privateParts.push(tldParts.shift());
  }

  parsed.tld = tldParts.join(<span class="hljs-string">'.'</span>);

  <span class="hljs-keyword">if</span> (!privateParts.length) {
    <span class="hljs-keyword">return</span> handlePunycode();
  }

  <span class="hljs-keyword">if</span> (rule.wildcard) {
    tldParts.unshift(privateParts.pop());
    parsed.tld = tldParts.join(<span class="hljs-string">'.'</span>);
  }

  <span class="hljs-keyword">if</span> (!privateParts.length) {
    <span class="hljs-keyword">return</span> handlePunycode();
  }

  parsed.sld = privateParts.pop();
  parsed.domain = [parsed.sld,  parsed.tld].join(<span class="hljs-string">'.'</span>);

  <span class="hljs-keyword">if</span> (privateParts.length) {
    parsed.subdomain = privateParts.join(<span class="hljs-string">'.'</span>);
  }

  <span class="hljs-keyword">return</span> handlePunycode();
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>Get domain.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">exports.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">domain</span>) </span>{

  <span class="hljs-keyword">if</span> (!domain) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">return</span> exports.parse(domain).domain || <span class="hljs-literal">null</span>;
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Check whether domain belongs to a known public suffix.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">exports.isValid = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">domain</span>) </span>{

  <span class="hljs-keyword">var</span> parsed = exports.parse(domain);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Boolean</span>(parsed.domain &amp;&amp; parsed.listed);
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
